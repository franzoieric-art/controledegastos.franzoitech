<!DOCTYPE html>
<html lang="pt-BR" class="">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Financeiro - Franzoi Tech</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --bg-color: #f5f5f7; --card-bg: #ffffff; --text-color: #1d1d1f; --muted-text: #6e6e73; --input-bg: #f5f5f7; --input-border: #d2d2d7; --primary-color: #0071e3; --border-color: #d2d2d7; --green-color: #30a14f; --red-color: #d82c0d; }
        html.dark { --bg-color: #000000; --card-bg: #1d1d1f; --text-color: #f5f5f7; --muted-text: #86868b; --input-bg: #3a3a3c; --input-border: #545458; --primary-color: #2997ff; --border-color: #424245; --green-color: #32d74b; --red-color: #ff453a; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: var(--bg-color); color: var(--text-color); }
        .card { background-color: var(--card-bg); border: 1px solid var(--border-color); }
        .input-field { border: 1px solid var(--input-border); background-color: var(--input-bg); color: var(--text-color); border-radius: 12px; }
        .month-content { display: none; } .month-content.active { display: block; }
    </style>
</head>
<body class="p-2 sm:p-4">

    <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-70 flex flex-col items-center justify-center hidden z-50 text-white">
        <svg class="animate-spin h-8 w-8 text-white mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
        <h2 class="text-xl font-semibold">Carregando dados...</h2>
        <p class="text-sm">Isso pode levar alguns segundos.</p>
    </div>

    <div id="auth-screen" class="container mx-auto max-w-md mt-10 p-8 card rounded-2xl">
        </div>

    <div id="app-screen" class="hidden">
        </div>

    <script type="module">
        import { firebaseConfig } from './js/config.js';
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);
        
        const authScreen = document.getElementById('auth-screen');
        const appScreen = document.getElementById('app-screen');
        const loadingOverlay = document.getElementById('loading-overlay');
        
        let App = {}; // Usaremos um objeto global para facilitar

        // ==================================================================
        // LÓGICA DE LOGIN (SEM MUDANÇAS SIGNIFICATIVAS)
        // ==================================================================
        
        onAuthStateChanged(auth, user => {
            if (user) {
                authScreen.classList.add('hidden');
                appScreen.classList.remove('hidden');
                loadingOverlay.classList.remove('hidden');
                handleLogin(user);
            } else {
                authScreen.classList.remove('hidden');
                appScreen.classList.add('hidden');
                App = {}; // Limpa o App ao deslogar
            }
        });
        
        // ... (seu código de auth, como mainAuthBtn.addEventListener, etc.)

        // ==================================================================
        // LÓGICA PRINCIPAL DA APLICAÇÃO (COM AS CORREÇÕES FINAIS)
        // ==================================================================
        async function handleLogin(user) {
            try {
                await user.getIdToken(true); // CORREÇÃO 1: Força atualização do token
                
                const docSnap = await getDoc(doc(db, 'users', user.uid));
                let userData = {};
                if (docSnap.exists()) {
                    userData = docSnap.data();
                }

                // Inicia o objeto App com os dados
                App = {
                    state: {
                        currentUserId: user.uid,
                        monthlyData: userData.monthlyData || {},
                        categories: userData.categories || [],
                        // ... outros estados
                    },
                    // ... (resto do seu objeto App original, com as funções render, recalculate, etc.)
                };
                
                // CORREÇÃO 2: Garante que os meses existem
                for (let i = 0; i < 12; i++) {
                    if (!App.state.monthlyData[i]) {
                        App.state.monthlyData[i] = { pjEntries: [], pfEntries: [], expenses: Array(31).fill(null).map(() => ({ personalEntries: [], businessEntries: [] })) };
                    }
                }

                // Inicializa a UI
                initializeAppUI();

            } catch (error) {
                console.error("Erro fatal ao carregar dados:", error);
                loadingOverlay.classList.add('hidden');
                alert("Não foi possível carregar seus dados. Verifique o console para mais detalhes.");
            }
        }
        
        function initializeAppUI() {
            // Recria a estrutura HTML principal
            // ... (seu código que cria as abas e os containers dos meses)

            // Liga os botões
            bindGlobalEventListeners();
            
            // Mostra o primeiro mês
            showMonth(new Date().getMonth());
            
            loadingOverlay.classList.add('hidden');
        }
        
        function showMonth(monthIndex) {
            // ... (sua função showMonth original)
        }

        function recalculateAndDisplayTotals(m) {
            // CORREÇÃO 3: Lógica defensiva
            const d = App.state.monthlyData[m];
            if (!d) return;

            const pjTotal = (d.pjEntries || []).reduce((sum, entry) => sum + (entry.amount || 0), 0);
            // ... (resto dos cálculos com a mesma lógica defensiva)
            
            // Atualiza o HTML
            document.getElementById(`companyCash-${m}`).textContent = `R$ ${pjTotal.toFixed(2)}`;
            // ... etc.
        }

        function bindGlobalEventListeners() {
            // Aqui vai sua função original COMPLETA que adiciona os listeners
            // para '.add-entry-btn', '.remove-btn', '.tab-button', etc.
            // Esta é a parte que "dá vida" aos botões.
            document.body.addEventListener('click', (event) => {
                const target = event.target;
                if (target.closest('.tab-button')) {
                    showMonth(parseInt(target.closest('.tab-button').dataset.monthIndex));
                }
                // ... (RESTO DA SUA LÓGICA DE CLIQUES)
            });
        }
    </script>
</body>
</html>
