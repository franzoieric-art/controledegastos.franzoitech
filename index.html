<!DOCTYPE html>
<html lang="pt-BR" class="">
<head>
    <meta http-equiv="Content-Type" content="text/html; charset=UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Painel Financeiro - Franzoi Tech</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        :root { --bg-color: #f5f5f7; --card-bg: #ffffff; --text-color: #1d1d1f; --muted-text: #6e6e73; --input-bg: #f5f5f7; --input-border: #d2d2d7; --primary-color: #0071e3; --border-color: #d2d2d7; --green-color: #30a14f; --red-color: #d82c0d; }
        html.dark { --bg-color: #000000; --card-bg: #1d1d1f; --text-color: #f5f5f7; --muted-text: #86868b; --input-bg: #3a3a3c; --input-border: #545458; --primary-color: #2997ff; --border-color: #424245; --green-color: #32d74b; --red-color: #ff453a; }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: var(--bg-color); color: var(--text-color); transition: background-color 0.3s, color 0.3s; }
        .card { background-color: var(--card-bg); border: 1px solid var(--border-color); }
        .input-field { border: 1px solid var(--input-border); background-color: var(--input-bg); color: var(--text-color); border-radius: 12px; }
        .month-content { display: none; } .month-content.active { display: block; }
    </style>
</head>
<body class="p-2 sm:p-4">

    <div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-70 flex flex-col items-center justify-center hidden z-50 text-white">
        <svg class="animate-spin h-8 w-8 text-white mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg>
        <h2 class="text-xl font-semibold">Carregando dados...</h2>
        <p class="text-sm">Isso pode levar alguns segundos.</p>
    </div>

    <div id="auth-screen" class="container mx-auto max-w-md mt-10 p-8 card rounded-2xl">
        <div class="text-center mb-6">
            <h1 id="auth-title" class="text-2xl font-bold">Acesso ao Painel</h1>
            <p class="text-gray-500 dark:text-gray-400">Fa√ßa login ou crie sua conta.</p>
        </div>
        <div class="space-y-4">
            <input type="email" id="email-input" placeholder="Email" class="w-full p-3 input-field">
            <input type="password" id="password-input" placeholder="Senha" class="w-full p-3 input-field">
            <input type="password" id="confirm-password-input" placeholder="Confirmar Senha" class="w-full p-3 input-field hidden">
        </div>
        <div id="auth-error" class="text-red-500 text-sm mt-4 text-center h-4"></div>
        <div class="mt-4 flex flex-col gap-2">
            <button id="main-auth-btn" class="w-full px-6 py-3 text-white font-semibold rounded-xl" style="background-color: var(--primary-color);">Entrar</button>
            <a href="#" id="forgot-password-link" class="text-center text-sm" style="color: var(--primary-color);">Esqueceu a senha?</a>
        </div>
        <div class="mt-4 text-center">
            <a href="#" id="toggle-auth-mode-link" class="text-sm text-gray-600 dark:text-gray-300 hover:underline">Ainda n√£o tem conta? Crie uma, <span class="font-semibold">√© gr√°tis!</span></a>
        </div>
    </div>

    <div id="app-screen" class="hidden">
        <div class="container mx-auto card p-4 md:p-8 rounded-2xl relative">
            <div class="flex justify-between items-start mb-8">
                <div>
                    <p class="font-bold">Rico Plus</p>
                    <p class="text-xs">by Franzoi Tech</p>
                </div>
                <div class="flex items-center gap-4">
                    <button id="theme-toggle-btn" class="p-2 rounded-full text-lg">üåô</button>
                    <button id="logout-btn" class="px-4 py-2 text-sm font-semibold rounded-lg">Sair</button>
                </div>
            </div>
            <div class="text-center mb-8">
                <h1 class="text-5xl md:text-6xl font-semibold">Painel Financeiro</h1>
                <p class="mt-4 text-xl text-gray-500 dark:text-gray-400">Sua central de controle financeiro.</p>
            </div>
            <div class="flex justify-center flex-wrap gap-2 mb-8" id="monthTabs"></div>
            <div id="monthContentContainer"></div>
        </div>
    </div>

    <script type="module">
        import { firebaseConfig } from './js/config.js';
        import { initializeApp } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";
        import { getAuth, createUserWithEmailAndPassword, signInWithEmailAndPassword, onAuthStateChanged, signOut, sendPasswordResetEmail } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";
        import { getFirestore, doc, setDoc, getDoc } from "https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";

        // Inicializa√ß√£o do Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Refer√™ncias Globais
        const authScreen = document.getElementById('auth-screen');
        const appScreen = document.getElementById('app-screen');
        const loadingOverlay = document.getElementById('loading-overlay');
        let App = {}; // Objeto principal da aplica√ß√£o

        // L√≥gica de Autentica√ß√£o
        let isLoginMode = true;
        const mainAuthBtn = document.getElementById('main-auth-btn');
        const toggleAuthModeLink = document.getElementById('toggle-auth-mode-link');
        const forgotPasswordLink = document.getElementById('forgot-password-link');
        const authError = document.getElementById('auth-error');
        const confirmPasswordInput = document.getElementById('confirm-password-input');
        const authTitle = document.getElementById('auth-title');

        const setAuthMode = (mode) => {
            isLoginMode = mode === 'login';
            authError.textContent = '';
            if (isLoginMode) {
                authTitle.textContent = 'Acesso ao Painel';
                mainAuthBtn.textContent = 'Entrar';
                confirmPasswordInput.classList.add('hidden');
                forgotPasswordLink.classList.remove('hidden');
                toggleAuthModeLink.innerHTML = 'Ainda n√£o tem conta? Crie uma, <span class="font-semibold">√© gr√°tis!</span>';
            } else {
                authTitle.textContent = 'Criar Nova Conta';
                mainAuthBtn.textContent = 'Criar Conta';
                confirmPasswordInput.classList.remove('hidden');
                forgotPasswordLink.classList.add('hidden');
                toggleAuthModeLink.textContent = 'J√° tem conta? Fa√ßa login';
            }
        };

        toggleAuthModeLink.addEventListener('click', (e) => {
            e.preventDefault();
            setAuthMode(isLoginMode ? 'signup' : 'login');
        });

        mainAuthBtn.addEventListener('click', () => {
            const email = document.getElementById('email-input').value;
            const password = document.getElementById('password-input').value;
            authError.textContent = '';
            if (isLoginMode) {
                signInWithEmailAndPassword(auth, email, password).catch(() => authError.textContent = 'Email ou senha inv√°lidos.');
            } else {
                const confirmPassword = confirmPasswordInput.value;
                if (password !== confirmPassword) {
                    authError.textContent = 'As senhas n√£o coincidem.';
                    return;
                }
                createUserWithEmailAndPassword(auth, email, password).catch(err => authError.textContent = 'Erro ao criar conta.');
            }
        });
        
        document.getElementById('logout-btn').addEventListener('click', () => signOut(auth));


        // ==================================================================
        // L√ìGICA PRINCIPAL DA APLICA√á√ÉO
        // ==================================================================
        
        onAuthStateChanged(auth, user => {
            if (user) {
                authScreen.classList.add('hidden');
                appScreen.classList.remove('hidden');
                loadingOverlay.classList.remove('hidden');
                handleLogin(user);
            } else {
                authScreen.classList.remove('hidden');
                appScreen.classList.add('hidden');
                App = {};
            }
        });

        async function handleLogin(user) {
            try {
                // CORRE√á√ÉO 1: For√ßa atualiza√ß√£o do token
                await user.getIdToken(true); 

                const docSnap = await getDoc(doc(db, 'users', user.uid));
                let userData = docSnap.exists() ? docSnap.data() : {};

                // Inicia o objeto App com os dados
                App = {
                    state: {
                        currentUserId: user.uid,
                        monthlyData: userData.monthlyData || {},
                        categories: userData.categories || [{ name: 'Outros', budget: 100 }],
                        creditCards: userData.creditCards || [],
                        activeMonthIndex: new Date().getMonth(),
                    },
                    render: {
                        // ... todas as fun√ß√µes de render v√£o aqui ...
                        tabs: () => {
                             const monthTabsContainer = document.getElementById('monthTabs');
                             if (!monthTabsContainer) return;
                             monthTabsContainer.innerHTML = App.state.monthNames.map((name, i) => `<button class="tab-button px-4 py-2 rounded-lg text-sm font-semibold ${i === App.state.activeMonthIndex ? 'bg-blue-500 text-white' : ''}" data-month-index="${i}">${name}</button>`).join('');
                        },
                        monthContent: (m) => {
                            const container = document.getElementById('monthContentContainer');
                            if(!container) return;
                            container.innerHTML = `<div id="month-${m}-content" class="month-content active"></div>`; // Simplificado, insira seu HTML completo aqui
                            recalculateAndDisplayTotals(m);
                        }
                    }
                };
                
                // CORRE√á√ÉO 2: Garante que os meses existem
                App.state.monthNames = ["Janeiro", "Fevereiro", "Mar√ßo", "Abril", "Maio", "Junho", "Julho", "Agosto", "Setembro", "Outubro", "Novembro", "Dezembro", "Balan√ßo Anual"];
                for (let i = 0; i < 12; i++) {
                    if (!App.state.monthlyData[i]) {
                        App.state.monthlyData[i] = { pjEntries: [], pfEntries: [], expenses: Array(31).fill(null).map(() => ({ personalEntries: [], businessEntries: [] })) };
                    }
                }

                initializeAppUI();

            } catch (error) {
                console.error("Erro fatal ao carregar dados:", error);
                loadingOverlay.classList.add('hidden');
                alert("N√£o foi poss√≠vel carregar seus dados. Verifique o console para mais detalhes.");
            }
        }
        
        function initializeAppUI() {
            bindGlobalEventListeners();
            showMonth(App.state.activeMonthIndex);
            loadingOverlay.classList.add('hidden');
        }
        
        function showMonth(monthIndex) {
            if(typeof monthIndex !== 'number') return;
            App.state.activeMonthIndex = monthIndex;
            App.render.tabs();
            App.render.monthContent(monthIndex);
        }

        function recalculateAndDisplayTotals(m) {
            // CORRE√á√ÉO 3: L√≥gica defensiva
            const d = App.state.monthlyData[m];
            if (!d) return;

            const pjTotal = (d.pjEntries || []).reduce((sum, entry) => sum + (entry.amount || 0), 0);
            const pfTotal = (d.pfEntries || []).reduce((sum, entry) => sum + (entry.amount || 0), 0);
            
            const monthDiv = document.getElementById(`month-${m}-content`);
            if(monthDiv){
                 // Aqui voc√™ insere o HTML do conte√∫do do m√™s e popula com os totais
                 // Exemplo:
                 monthDiv.innerHTML = `
                    <h2 class="text-xl font-bold">Resumo de ${App.state.monthNames[m]}</h2>
                    <p>Ganhos PJ: ${helpers.formatCurrency(pjTotal)}</p>
                    <p>Ganhos PF: ${helpers.formatCurrency(pfTotal)}</p>
                    `;
            }
        }

        const helpers = {
             formatCurrency: (value) => {
                if (typeof value !== 'number') value = 0;
                return `R$ ${value.toFixed(2).replace('.', ',')}`;
            }
        }

        function bindGlobalEventListeners() {
            document.body.addEventListener('click', (event) => {
                const target = event.target;
                if (target.closest('.tab-button')) {
                    showMonth(parseInt(target.closest('.tab-button').dataset.monthIndex));
                }
                // ... RESTO DA SUA L√ìGICA DE CLIQUES PARA ADICIONAR/REMOVER
            });
        }
    </script>
</body>
</html>
