<!DOCTYPE html><html lang="pt-BR" class=""><head><meta http-equiv="Content-Type" content="text/html; charset=UTF-8"><meta name="viewport" content="width=device-width,initial-scale=1"><title>Painel Financeiro - Franzoi Tech</title><link rel="icon" type="image/png" href="/favicon-96x96.png" sizes="96x96"><link rel="icon" type="image/svg+xml" href="/favicon.svg"><link rel="shortcut icon" href="/favicon.ico"><link rel="apple-touch-icon" sizes="180x180" href="/apple-touch-icon.png"><meta name="apple-mobile-web-app-title" content="FranzoiTech"><link rel="manifest" href="/site.webmanifest"><script src="https://cdn.tailwindcss.com"></script><script src="https://cdn.jsdelivr.net/npm/chart.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script><script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script><script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script><style>:root {
            --bg-color: #f5f5f7; --card-bg: #ffffff; --text-color: #1d1d1f; --muted-text: #6e6e73;
            --input-bg: #f5f5f7; --input-border: #d2d2d7; --primary-color: #0071e3; --primary-color-hover: #0077ed;
            --secondary-bg: #e8e8ed; --secondary-text: #1d1d1f; --border-color: #d2d2d7;
            --green-color: #30a14f; --red-color: #d82c0d;
        }
        html.dark {
            --bg-color: #000000; --card-bg: #1d1d1f; --text-color: #f5f5f7; --muted-text: #86868b;
            --input-bg: #3a3a3c; --input-border: #545458; --primary-color: #2997ff; --primary-color-hover: #53b0ff;
            --secondary-bg: #3a3a3c; --secondary-text: #f5f5f7; --border-color: #424245;
            --green-color: #32d74b; --red-color: #ff453a;
        }
        body { font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif; background-color: var(--bg-color); color: var(--text-color); transition: background-color 0.3s, color 0.3s; -webkit-font-smoothing: antialiased; -moz-osx-font-smoothing: grayscale; }
        .card { background-color: var(--card-bg); border: 1px solid var(--border-color); box-shadow: 0 1px 2px 0 rgba(0, 0, 0, 0.03); }
        .input-field { border: 1px solid var(--input-border); background-color: var(--input-bg); color: var(--text-color); border-radius: 12px; }
        .input-field:focus { outline: none; border-color: var(--primary-color); box-shadow: 0 0 0 3px rgba(0, 113, 227, 0.2); }
        .muted-text { color: var(--muted-text); }
        input[type="number"]::-webkit-inner-spin-button, input[type="number"]::-webkit-outer-spin-button { -webkit-appearance: none; margin: 0; }
        input[type="number"] { -moz-appearance: textfield; appearance: none; }
        .remove-btn { background-color: var(--secondary-bg); color: var(--muted-text); border-radius: 9999px; width: 1.75rem; height: 1.75rem; font-weight: 500; transition: background-color 0.2s, color 0.2s; flex-shrink: 0; display: inline-flex; align-items: center; justify-content: center; }
        .remove-btn:hover { background-color: var(--red-color); color: white; }
        .month-content { display: none; } .month-content.active { display: block; }
        #save-feedback { position: fixed; bottom: 20px; left: 50%; transform: translateX(-50%); padding: 12px 24px; background-color: var(--green-color); color: white; border-radius: 9999px; box-shadow: 0 4px 12px rgba(0,0,0,0.15); font-weight: 500; z-index: 100; opacity: 0; visibility: hidden; transition: opacity 0.3s, visibility 0.3s, transform 0.3s; }
        #save-feedback.show { opacity: 1; visibility: visible; transform: translateX(-50%) translateY(-10px); }
        .accordion-content { max-height: 0; overflow: hidden; transition: max-height 0.3s ease-out, padding 0.3s ease-out; padding: 0 1.5rem; border-top: 1px solid var(--border-color); }
        .accordion-item.active .accordion-content { max-height: 1000px; padding: 1.5rem; }
        .accordion-trigger .arrow { transition: transform 0.3s ease-out; }
        .accordion-item.active .accordion-trigger .arrow { transform: rotate(180deg); }
        .prose { color: var(--text-color); } .prose h3 { font-size: 1.25rem; font-weight: 600; margin-bottom: 0.5em; }
        .prose p { margin-bottom: 1em; line-height: 1.6; } .prose ul { list-style-position: inside; margin-bottom: 1em; padding-left: 1em; }
        .prose li { margin-bottom: 0.5em; }
        .tooltip-container { position: relative; display: inline-flex; align-items: center; }
        .tooltip-text { visibility: hidden; width: 160px; background-color: #333; color: #fff; text-align: center; border-radius: 6px; padding: 8px; position: absolute; z-index: 10; bottom: 125%; left: 50%; margin-left: -80px; opacity: 0; transition: opacity 0.2s; font-size: 0.8rem; pointer-events: none; }
        .tooltip-container:focus .tooltip-text { visibility: visible; opacity: 1; }
        .action-buttons { display: flex; flex-direction: column; gap: 0.5rem; }
        @media (min-width: 640px) { .action-buttons { flex-direction: row; } }
        #theme-toggle-btn { font-size: 1.25rem !important; color: var(--text-color) !important; background-image: none !important; line-height: 1; }
        #theme-toggle-btn::before, #theme-toggle-btn::after { content: none !important; display: none !important; }
        .calendar-grid { display: grid; grid-template-columns: repeat(7, 1fr); gap: 8px; border: 1px solid var(--border-color); padding: 1rem; border-radius: 1.5rem; }
        .calendar-header { text-align: center; font-weight: 600; color: var(--muted-text); padding-bottom: 0.5rem; font-size: 0.875rem; }
        .calendar-day { display: flex; align-items: center; justify-content: center; height: 48px; border-radius: 9999px; cursor: pointer; transition: background-color 0.2s, color 0.2s; position: relative; }
        .calendar-day.not-current-month { color: var(--muted-text); opacity: 0.5; cursor: default; }
        .calendar-day.current-month:hover { background-color: var(--secondary-bg); }
        .calendar-day.active { background-color: var(--primary-color); color: white; font-weight: 600; }
        .calendar-day.has-entries::after { content: ''; position: absolute; bottom: 8px; left: 50%; transform: translateX(-50%); width: 5px; height: 5px; border-radius: 50%; background-color: var(--red-color); }
        .calendar-day.active.has-entries::after { background-color: white; }
        [id^="expense-section-wrapper-"] .accordion-item { display: none; }
        [id^="expense-section-wrapper-"] .accordion-item.active { display: block; }
        .calendar-nav-header { border: 1px solid var(--border-color); }
        .calendar-nav-btn { font-size: 1.75rem; font-weight: 300; color: var(--primary-color); width: 2.5rem; height: 2.5rem; border-radius: 9999px; transition: background-color 0.2s, color 0.2s, transform 0.2s; display: flex; align-items: center; justify-content: center; line-height: 1; background-color: transparent; border: none; cursor: pointer; }
        .calendar-nav-btn:hover { background-color: var(--secondary-bg); color: var(--primary-color); transform: scale(1.1); }
        .calendar-nav-btn:active { transform: scale(0.95); }</style></head><body class="p-2 sm:p-4"><div id="loading-overlay" class="fixed inset-0 bg-black bg-opacity-70 flex-col items-center justify-center hidden z-50 text-white"><svg class="animate-spin h-8 w-8 text-white mb-4" xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"><circle class="opacity-25" cx="12" cy="12" r="10" stroke="currentColor" stroke-width="4"></circle><path class="opacity-75" fill="currentColor" d="M4 12a8 8 0 018-8V0C5.373 0 0 5.373 0 12h4zm2 5.291A7.962 7.962 0 014 12H0c0 3.042 1.135 5.824 3 7.938l3-2.647z"></path></svg><h2 class="text-xl font-semibold">Carregando dados...</h2><p class="text-sm">Isso pode levar alguns segundos.</p></div><div id="auth-screen" class="container mx-auto max-w-md mt-10 p-8 card rounded-2xl"><div class="text-center mb-6"><div class="flex justify-center mb-4"><img src="images/logo.png" alt="Logo Franzoi Tech" width="100" height="100"></div><h1 id="auth-title" class="text-2xl font-bold">Acesso ao Painel</h1><p class="muted-text">Faça login ou crie sua conta.</p></div><div class="space-y-4"><input type="email" id="email-input" placeholder="Email" class="w-full p-3 input-field"><input type="password" id="password-input" placeholder="Senha" class="w-full p-3 input-field"><input type="password" id="confirm-password-input" placeholder="Confirmar Senha" class="w-full p-3 input-field hidden"></div><div id="auth-error" class="text-red-500 text-sm mt-4 text-center h-4"></div><div class="mt-4 flex flex-col gap-2"><button id="main-auth-btn" class="w-full px-6 py-3 text-white font-semibold rounded-xl shadow-md transition-colors disabled:opacity-50" style="background-color: var(--primary-color);" onmouseover='this.style.backgroundColor=getComputedStyle(this).getPropertyValue("--primary-color-hover")' onmouseout='this.style.backgroundColor=getComputedStyle(this).getPropertyValue("--primary-color")'>Entrar</button><a href="#" id="forgot-password-link" class="text-center text-sm hover:underline" style="color: var(--primary-color);">Esqueceu a senha?</a></div><div class="mt-4 text-center"><a href="#" id="toggle-auth-mode-link" class="text-sm muted-text hover:underline">Ainda não tem conta? Crie uma, <span class="font-semibold">é grátis!</span></a></div></div><div id="app-screen" class="hidden"><div id="chatbot-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-end justify-end p-4 hidden z-50 transition-opacity"><div class="modal-content card rounded-2xl shadow-xl w-full max-w-md h-2/3 flex flex-col transform translate-y-8 transition-transform"><div class="flex justify-between items-center p-4 border-b flex-shrink-0" style="border-color: var(--border-color);"><h2 class="text-xl font-bold">Assistente IA</h2><button id="close-chatbot-modal-btn" class="px-3 py-1 rounded-lg" style="background-color: var(--secondary-bg);">&times;</button></div><div id="chatbot-messages" class="flex-grow p-4 overflow-y-auto space-y-4"><div class="p-3 rounded-lg max-w-[85%] text-sm" style="background-color: var(--secondary-bg);"><p class="font-bold mb-1">Assistente</p><p>Olá! Como posso ajudar com suas finanças hoje?</p></div></div><div class="p-4 border-t flex gap-2 flex-shrink-0" style="border-color: var(--border-color);"><input type="text" id="chatbot-input" placeholder="Ex: Qual foi meu maior gasto em Setembro?" class="flex-grow p-3 input-field"><button id="chatbot-send-btn" class="px-5 py-3 text-white font-semibold rounded-xl" style="background-color: var(--primary-color);">Enviar</button></div></div></div><div id="account-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50"><div class="modal-content card rounded-2xl shadow-xl w-full max-w-2xl p-6 transform scale-95 flex flex-col max-h-[90vh]"><div class="flex justify-between items-center mb-6 flex-shrink-0"><h2 class="text-2xl font-bold">Minha Conta</h2><button id="close-account-modal-btn" class="px-4 py-2 rounded-lg" style="background-color: var(--secondary-bg); color: var(--secondary-text);">Fechar</button></div><div class="overflow-y-auto space-y-6"><div><h3 class="text-lg font-semibold mb-3">Informações do Perfil</h3><div class="grid grid-cols-1 md:grid-cols-2 gap-4"><div><label for="user-name-input" class="block text-sm font-medium muted-text mb-1">Nome Completo</label><input type="text" id="user-name-input" placeholder="Seu nome" class="w-full p-3 input-field"></div><div><label for="user-email-display" class="block text-sm font-medium muted-text mb-1">Email</label><input type="email" id="user-email-display" class="w-full p-3 input-field" disabled="disabled" style="opacity: 0.7;"></div></div><button id="save-profile-btn" class="mt-4 w-full px-6 py-3 text-white font-semibold rounded-xl shadow-md transition-colors" style="background-color: var(--primary-color);">Salvar Alterações do Perfil</button></div><div class="border-t pt-6" style="border-color: var(--border-color);"><h3 class="text-xl font-bold mb-1">Conectar Assistente IA via WhatsApp</h3><p class="muted-text text-sm mb-4">Configure a integração para lançar despesas e interagir com seu painel diretamente do WhatsApp.</p><div class="p-3 mb-4 rounded-xl text-center text-sm" style="background-color: var(--secondary-bg);">✨ <span class="font-semibold">Funcionalidade em desenvolvimento.</span> Disponível em breve!</div><div class="space-y-4 opacity-60"><div class="p-4 rounded-xl space-y-4" style="background-color: var(--input-bg);"><h4 class="font-semibold">Passo 1: Suas Credenciais da Meta</h4><p class="text-xs muted-text -mt-3">Insira as credenciais da sua API encontradas no <a href="#" class="underline" style="color: var(--primary-color);">Painel de Desenvolvedores</a>.</p><div><label for="whatsapp-phone-id" class="block text-sm font-medium muted-text mb-1">ID do Número de Telefone</label><input type="text" id="whatsapp-phone-id" placeholder="Ex: 102030405060708" class="w-full p-3 input-field" disabled="disabled"></div><div><label for="whatsapp-token" class="block text-sm font-medium muted-text mb-1">Token de Acesso da API</label><input type="password" id="whatsapp-token" placeholder="Cole seu token permanente aqui" class="w-full p-3 input-field" disabled="disabled"></div></div><div class="p-4 rounded-xl space-y-4" style="background-color: var(--input-bg);"><h4 class="font-semibold">Passo 2: Configurar Webhook na Meta</h4><p class="text-xs muted-text -mt-3">Copie os valores abaixo e cole-os na seção "Webhook" da sua aplicação na Meta.</p><div><label class="block text-sm font-medium muted-text mb-1">URL do Webhook (para colar na Meta)</label><div class="flex gap-2"><input type="text" id="whatsapp-webhook-url" class="w-full p-3 input-field" readonly="readonly" disabled="disabled"><button id="copy-webhook-url-btn" class="px-4 py-2 text-sm font-semibold rounded-lg" style="background-color: var(--secondary-bg); color: var(--secondary-text);" disabled="disabled">Copiar</button></div></div><div><label class="block text-sm font-medium muted-text mb-1">Token de Verificação do Webhook (para colar na Meta)</label><div class="flex gap-2"><input type="text" id="whatsapp-verify-token" class="w-full p-3 input-field" readonly="readonly" disabled="disabled"><button id="generate-verify-token-btn" class="px-4 py-2 text-sm font-semibold rounded-lg" style="background-color: var(--secondary-bg); color: var(--secondary-text);" disabled="disabled">Gerar</button></div></div></div><div class="mt-4 flex items-center justify-between"><div class="text-sm muted-text">Status: <span id="whatsapp-status" class="font-semibold" style="color: var(--primary-color);">Indisponível</span></div><button id="save-integration-btn" class="px-6 py-3 text-white font-semibold rounded-xl shadow-md transition-colors" style="background-color: var(--primary-color);" disabled="disabled">Salvar Configuração</button></div></div></div></div></div></div><div id="settings-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50"><div class="modal-content card rounded-2xl shadow-xl w-full max-w-6xl p-6 transform scale-95 flex flex-col max-h-[90vh]"><div class="flex justify-between items-center mb-6 flex-shrink-0"><h2 class="text-2xl font-bold">Gerenciar</h2><button id="close-modal-btn" class="px-4 py-2 rounded-lg" style="background-color: var(--secondary-bg); color: var(--secondary-text);">Fechar</button></div><div class="grid grid-cols-1 lg:grid-cols-3 gap-6 overflow-y-auto"><div><h3 class="text-lg font-semibold mb-3">Cartões de Crédito</h3><div class="flex gap-2 mb-4"><input type="text" id="new-card-name" placeholder="Nome do Cartão" class="flex-grow p-2 input-field"><button id="add-card-btn" class="px-4 py-2 text-white rounded-lg" style="background-color: var(--primary-color);">Adicionar</button></div><div id="card-list" class="flex flex-col gap-2 max-h-96 overflow-y-auto"></div></div><div><h3 class="text-lg font-semibold mb-3">Categorias e Metas</h3><div class="flex gap-2 mb-4"><input type="text" id="new-category-name" placeholder="Nova Categoria" class="flex-grow p-2 input-field"><button id="add-category-btn" class="px-4 py-2 text-white rounded-lg" style="background-color: var(--primary-color);">Adicionar</button></div><div id="category-list" class="flex flex-col gap-2 max-h-96 overflow-y-auto"></div></div><div><h3 class="text-lg font-semibold mb-3">Lançamentos Recorrentes</h3><div id="recurring-form" class="space-y-2 p-3 border rounded-xl mb-4 text-sm" style="background-color: var(--input-bg); border-color: var(--input-border);"><input type="text" id="recurring-desc" placeholder="Descrição" class="w-full p-2 input-field"><div class="grid grid-cols-2 gap-2"><input type="number" id="recurring-amount" placeholder="Valor" class="w-full p-2 input-field"><input type="number" id="recurring-day" placeholder="Dia do Mês" min="1" max="31" class="w-full p-2 input-field"></div><select id="recurring-type" class="w-full p-2 input-field"></select><div id="recurring-expense-fields" class="space-y-2 hidden"><select id="recurring-category" class="w-full p-2 input-field"></select><select id="recurring-payment" class="w-full p-2 input-field"></select><select id="recurring-card" class="w-full p-2 input-field hidden"></select></div><button id="add-recurring-btn" class="w-full px-4 py-2 text-white rounded-lg" style="background-color: var(--primary-color);">Adicionar Recorrência</button></div><div id="recurring-list" class="flex flex-col gap-2 max-h-96 overflow-y-auto"></div></div></div></div></div><div id="ai-analysis-modal" class="modal-overlay fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 hidden z-50"><div class="modal-content card rounded-2xl shadow-xl w-full max-w-2xl p-6 transform scale-95 flex flex-col max-h-[90vh]"><div class="flex justify-between items-center mb-4 flex-shrink-0"><h2 class="text-2xl font-bold">Análise Financeira com IA</h2><button id="close-ai-modal-btn" class="px-4 py-2 rounded-lg" style="background-color: var(--secondary-bg); color: var(--secondary-text);">Fechar</button></div><div id="ai-analysis-result" class="overflow-y-auto prose dark:prose-invert"><p class="muted-text">Analisando seus dados...</p></div></div></div><div class="container mx-auto card p-4 md:p-8 rounded-2xl relative"><div id="save-feedback">Salvo ✓</div><div id="user-header" class="flex items-start justify-between mb-8 pb-8 border-b" style="border-color: var(--border-color);"><div class="flex items-center space-x-4"><label for="avatar-upload-input" class="cursor-pointer group relative"><img id="user-avatar" src="images/default-avatar.svg" class="w-14 h-14 rounded-full object-cover border-2 transition-all group-hover:opacity-80" style="border-color: var(--border-color);"><div class="absolute inset-0 bg-black bg-opacity-50 rounded-full flex items-center justify-center opacity-0 group-hover:opacity-100 transition-opacity"><svg class="h-6 w-6 text-white" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 9a2 2 0 012-2h.93a2 2 0 001.664-.89l.812-1.22A2 2 0 0110.07 4h3.86a2 2 0 011.664.89l.812 1.22A2 2 0 0018.07 7H19a2 2 0 012 2v9a2 2 0 01-2 2H5a2 2 0 01-2-2V9z"></path><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M15 13a3 3 0 11-6 0 3 3 0 016 0z"></path></svg></div></label> <input type="file" id="avatar-upload-input" class="hidden" accept="image/png, image/jpeg"><div><p id="time-greeting" class="text-sm muted-text">Boa tarde!</p><h2 id="greeting-text" class="text-2xl font-bold leading-tight">Olá, Eric</h2></div></div><div class="flex items-center gap-2"><div class="action-buttons"><button id="manage-account-btn" class="px-3 py-1 text-sm font-semibold rounded-lg" style="background-color: var(--secondary-bg); color: var(--secondary-text);">Conta</button><button id="manage-settings-btn" class="px-3 py-1 text-sm font-semibold rounded-lg" style="background-color: var(--secondary-bg); color: var(--secondary-text);">Gerenciar</button><button id="logout-btn" class="px-3 py-1 text-sm font-semibold rounded-lg" style="background-color: var(--secondary-bg); color: var(--red-color);">Sair</button></div><button id="theme-toggle-btn" class="p-2 rounded-full text-lg self-start" style="background-color: var(--secondary-bg); color: var(--secondary-text);">🌙</button></div></div><div class="text-center mb-8 space-y-2"><p class="text-xs font-semibold" style="color: var(--primary-color);">Rico Plus <span class="muted-text">by Franzoi Tech</span></p><h1 class="text-4xl sm:text-5xl font-extrabold tracking-tight">Painel Financeiro</h1><p class="text-lg muted-text max-w-xs mx-auto">Mais que números, decisões inteligentes.</p></div><div id="monthContentContainer"></div><div class="mt-12 pt-8 border-t text-center" style="border-color: var(--border-color);"><p class="text-sm muted-text">Ajude a manter este projeto</p><p class="text-xs muted-text mb-2">Doe qualquer valor via Pix</p><div class="mt-2 flex justify-center"><img src="images/pix qrcode.jpeg" alt="QR Code PIX para doação" width="150" height="150"></div><div class="mt-2"><p class="text-xs muted-text">Ou use a chave (email):</p><div class="mt-1 flex justify-center items-center gap-2"><p id="pix-key" class="font-mono text-sm" style="color: var(--primary-color);">franzoitechcorp@gmail.com</p><button id="copy-pix-btn" class="px-3 py-1 text-xs font-semibold rounded-lg" style="background-color: var(--secondary-bg); color: var(--secondary-text);">Copiar</button></div></div></div></div></div><button id="floating-chatbot-btn" class="fixed bottom-6 right-6 w-16 h-16 rounded-full text-3xl flex items-center justify-center shadow-lg transition-transform hover:scale-110" style="background-color: var(--primary-color); color: white;">🤖</button><script type="module">import{initializeApp}from"https://www.gstatic.com/firebasejs/9.15.0/firebase-app.js";import{getAuth,createUserWithEmailAndPassword,signInWithEmailAndPassword,onAuthStateChanged,signOut,sendPasswordResetEmail}from"https://www.gstatic.com/firebasejs/9.15.0/firebase-auth.js";import{getFirestore,doc,setDoc,getDoc}from"https://www.gstatic.com/firebasejs/9.15.0/firebase-firestore.js";import{getStorage,ref,uploadBytes,getDownloadURL}from"https://www.gstatic.com/firebasejs/9.15.0/firebase-storage.js";const firebaseConfig={apiKey:"AIzaSyApSIolaeRxXdVNsnZkAvz_F_ILmxs1_K0",authDomain:"controle-de-gastos-74daf.firebaseapp.com",projectId:"controle-de-gastos-74daf",storageBucket:"controle-de-gastos-74daf.firebasestorage.app",messagingSenderId:"331667008487",appId:"1:331667008487:web:c5200f64ac27d0c32feb42"},app=initializeApp(firebaseConfig),auth=getAuth(app),db=getFirestore(app),storage=getStorage(app),authScreen=document.getElementById("auth-screen"),appScreen=document.getElementById("app-screen"),mainAuthBtn=document.getElementById("main-auth-btn"),toggleAuthModeLink=document.getElementById("toggle-auth-mode-link"),forgotPasswordLink=document.getElementById("forgot-password-link"),authError=document.getElementById("auth-error"),themeToggleBtn=document.getElementById("theme-toggle-btn"),loadingOverlay=document.getElementById("loading-overlay");let isLoginMode=!0;const handleAuthKeyPress=e=>{"Enter"===e.key&&(e.preventDefault(),mainAuthBtn.click())};document.getElementById("email-input").addEventListener("keydown",handleAuthKeyPress),document.getElementById("password-input").addEventListener("keydown",handleAuthKeyPress),document.getElementById("confirm-password-input").addEventListener("keydown",handleAuthKeyPress);const showError=e=>{authError.textContent=e},setAuthMode=e=>{isLoginMode="login"===e,authError.textContent="";const t=document.getElementById("auth-title"),a=document.getElementById("confirm-password-input");isLoginMode?(t.textContent="Acesso ao Painel",mainAuthBtn.textContent="Entrar",a.classList.add("hidden"),forgotPasswordLink.classList.remove("hidden"),toggleAuthModeLink.innerHTML='Ainda não tem conta? Crie uma, <span class="font-semibold">é grátis!</span>'):(t.textContent="Criar Nova Conta",mainAuthBtn.textContent="Criar Conta",a.classList.remove("hidden"),forgotPasswordLink.classList.add("hidden"),toggleAuthModeLink.textContent="Já tem conta? Faça login")},applyTheme=e=>{document.documentElement.classList.toggle("dark","dark"===e),themeToggleBtn.textContent="dark"===e?"☀️":"🌙",window.App&&App.state.currentUserId&&App.showMonth(App.state.activeMonthIndex)};applyTheme(localStorage.getItem("theme")||"light"),toggleAuthModeLink.addEventListener("click",e=>{e.preventDefault(),setAuthMode(isLoginMode?"signup":"login")}),mainAuthBtn.addEventListener("click",()=>{const e=document.getElementById("email-input").value,t=document.getElementById("password-input").value;showError("");const a=mainAuthBtn.textContent;mainAuthBtn.disabled=!0,mainAuthBtn.textContent="Aguarde...";const n=()=>{mainAuthBtn.disabled=!1,mainAuthBtn.textContent=a};if(isLoginMode)signInWithEmailAndPassword(auth,e,t).catch(e=>{showError("Email ou senha inválidos."),n()});else{if(t!==document.getElementById("confirm-password-input").value)return showError("As senhas não coincidem."),void n();createUserWithEmailAndPassword(auth,e,t).catch(e=>{"auth/email-already-in-use"===e.code?showError("Este email já está em uso."):"auth/weak-password"===e.code?showError("A senha deve ter pelo menos 6 caracteres."):showError("Erro ao criar conta."),n()})}}),forgotPasswordLink.addEventListener("click",e=>{e.preventDefault();const t=document.getElementById("email-input").value;t?sendPasswordResetEmail(auth,t).then(()=>{showError("Email de recuperação enviado!")}).catch(e=>{showError("Não foi possível enviar o email.")}):showError("Por favor, insira seu email para recuperar a senha.")}),document.getElementById("logout-btn").addEventListener("click",()=>{signOut(auth)});const App={state:{currentUserId:null,profile:{name:"",avatarUrl:""},integrations:{whatsapp:{phoneNumberId:"",accessToken:"",webhookVerifyToken:""}},creditCards:[],categories:[{name:"Alimentação",budget:500},{name:"Transporte",budget:150},{name:"Moradia",budget:1500},{name:"Lazer",budget:300},{name:"Saúde",budget:200},{name:"Outros",budget:100}],recurringEntries:[],monthlyData:{},activeMonthIndex:(new Date).getMonth(),lastViewedMonthIndex:(new Date).getMonth(),chartInstances:{},saveTimeout:null},ui:{monthContentContainer:document.getElementById("monthContentContainer"),settingsModal:document.getElementById("settings-modal"),accountModal:document.getElementById("account-modal"),userNameInput:document.getElementById("user-name-input"),userEmailDisplay:document.getElementById("user-email-display"),whatsappPhoneId:document.getElementById("whatsapp-phone-id"),whatsappToken:document.getElementById("whatsapp-token"),whatsappWebhookUrl:document.getElementById("whatsapp-webhook-url"),whatsappVerifyToken:document.getElementById("whatsapp-verify-token"),whatsappStatus:document.getElementById("whatsapp-status"),newCardNameInput:document.getElementById("new-card-name"),cardListContainer:document.getElementById("card-list"),newCategoryNameInput:document.getElementById("new-category-name"),categoryListContainer:document.getElementById("category-list"),recurringListContainer:document.getElementById("recurring-list"),saveFeedback:document.getElementById("save-feedback"),aiAnalysisModal:document.getElementById("ai-analysis-modal"),aiAnalysisResult:document.getElementById("ai-analysis-result")},constants:{monthNames:["Janeiro","Fevereiro","Março","Abril","Maio","Junho","Julho","Agosto","Setembro","Outubro","Novembro","Dezembro","Balanço Anual"],basePaymentMethods:["Pix","Débito","Crédito","Dinheiro","Outro"]},init(e){this.state.currentUserId=e,this.loadData(),this.bindGlobalEventListeners()},helpers:{formatCurrency:e=>`R$ ${e.toFixed(2).replace(".",",")}`,debounce(e,t){return(...a)=>{clearTimeout(App.state.saveTimeout),App.state.saveTimeout=setTimeout(()=>{e.apply(this,a)},t)}},showSaveFeedback(){App.ui.saveFeedback.classList.add("show"),setTimeout(()=>{App.ui.saveFeedback.classList.remove("show")},2e3)},cleanAIResponse(e){if("string"!=typeof e)return"";let t=e.replace(/```html|```/g,"");const a=t.indexOf("<");a>-1&&(t=t.substring(a));const n=["Observações:","Como usar:","Cálculo dos Totais:","Formatação HTML:","Personalização das Sugestões:"];for(const e of n){const a=t.indexOf(e);a>50&&(t=t.substring(0,a))}return t.trim()},generateRandomToken:()=>[...Array(32)].map(()=>Math.floor(16*Math.random()).toString(16)).join("")},async handleAvatarUpload(e){const t=e.target.files[0];if(!t)return;if(!this.state.currentUserId)return;const a=document.getElementById("user-avatar"),n=a.src;a.style.opacity="0.5";try{const e=`avatars/${this.state.currentUserId}`,n=ref(storage,e);await uploadBytes(n,t);const s=await getDownloadURL(n);this.state.profile.avatarUrl=s,a.src=s,await this.saveDataToFirestore()}catch(e){console.error("Erro no upload do avatar:",e),a.src=n}finally{a.style.opacity="1"}},async saveDataToFirestore(){if(App.state.currentUserId)try{const e={profile:App.state.profile,integrations:App.state.integrations,monthlyData:App.state.monthlyData,creditCards:App.state.creditCards,categories:App.state.categories,recurringEntries:App.state.recurringEntries};await setDoc(doc(db,"users",App.state.currentUserId),e,{merge:!0}),App.helpers.showSaveFeedback()}catch(e){console.error("Erro ao salvar dados: ",e)}},debouncedSave:null,async loadData(){if(this.state.currentUserId){try{const e=await getDoc(doc(db,"users",this.state.currentUserId));if(e.exists()){const t=e.data();this.state.profile=t.profile||{name:"",avatarUrl:""},this.state.integrations=t.integrations||{whatsapp:{phoneNumberId:"",accessToken:"",webhookVerifyToken:""}},this.state.monthlyData=t.monthlyData||{},this.state.creditCards=t.creditCards||[],this.state.categories=t.categories&&t.categories.length>0?t.categories:this.state.categories,this.state.recurringEntries=t.recurringEntries||[]}this.state.integrations.whatsapp.webhookVerifyToken||(this.state.integrations.whatsapp.webhookVerifyToken=this.helpers.generateRandomToken());for(let e=0;e<12;e++)this.state.monthlyData[e]=this.state.monthlyData[e]||{pjEntries:[],pfEntries:[],expenses:Array(31).fill(null).map(()=>({personalEntries:[],businessEntries:[]}))},this.state.monthlyData[e].expenses.forEach(e=>{[...e.personalEntries,...e.businessEntries].forEach(e=>{e.category||(e.category="Outros")})})}catch(e){console.error("Erro ao carregar dados:",e)}this.ui.monthContentContainer.innerHTML="",this.constants.monthNames.forEach((e,t)=>{this.ui.monthContentContainer.insertAdjacentHTML("beforeend",12===t?this.render.createBalanceContentHTML():this.render.createMonthContentHTML(t))}),this.showMonth(this.state.activeMonthIndex),loadingOverlay.classList.add("hidden"),this.render.updateHeader()}},showMonth(e){this.state.activeMonthIndex!==e&&this.state.saveTimeout&&(clearTimeout(this.state.saveTimeout),this.saveDataToFirestore(),this.state.saveTimeout=null),e>=0&&e<=11&&(this.state.lastViewedMonthIndex=e),this.state.activeMonthIndex=e,Object.values(this.state.chartInstances).forEach(e=>e?.destroy()),document.querySelectorAll(".month-content").forEach(e=>e.classList.remove("active")),e<12&&this.applyRecurringEntries(e);const t=document.getElementById(`month-${e}-content`);t&&(t.classList.add("active"),e<12?(this.render.renderCalendarView(e),this.render.renderPJEntries(e),this.render.renderPFEntries(e),this.render.renderExpenseTable(e),this.recalculateAndDisplayTotals(e)):this.render.renderBalanceSummary())},recalculateAndDisplayTotals(e){const t=this.state.monthlyData[e];if(!t)return;const a={pj:t.pjEntries.reduce((e,t)=>e+t.amount,0),pf:t.pfEntries.reduce((e,t)=>e+t.amount,0),personal:t.expenses.flat().reduce((e,t)=>e+t.personalEntries.reduce((e,t)=>e+t.amount,0),0),business:t.expenses.flat().reduce((e,t)=>e+t.businessEntries.reduce((e,t)=>e+t.amount,0),0)};a.remainingPersonal=a.pf-a.personal,a.remainingBusiness=a.pj-a.business,a.remainingTotal=a.pj+a.pf-(a.personal+a.business),document.getElementById(`companyCash-${e}`).textContent=this.helpers.formatCurrency(a.pj),document.getElementById(`personalCash-${e}`).textContent=this.helpers.formatCurrency(a.pf),document.getElementById(`totalPersonalExpenses-${e}`).textContent=this.helpers.formatCurrency(a.personal),document.getElementById(`totalBusinessExpenses-${e}`).textContent=this.helpers.formatCurrency(a.business);const n=document.getElementById(`remainingPersonal-${e}`);n.textContent=this.helpers.formatCurrency(a.remainingPersonal),n.style.color=a.remainingPersonal<0?"var(--red-color)":"var(--green-color)";const s=document.getElementById(`remainingBusiness-${e}`);s.textContent=this.helpers.formatCurrency(a.remainingBusiness),s.style.color=a.remainingBusiness<0?"var(--red-color)":"var(--green-color)";const o=document.getElementById(`remainingTotal-${e}`);o.textContent=this.helpers.formatCurrency(a.remainingTotal),o.style.color=a.remainingTotal<0?"var(--red-color)":"var(--primary-color)",this.render.updateBudgetAlerts(e),this.render.updateAllCharts(e,{totalPersonal:a.personal,totalBusiness:a.business,remainingBudget:a.remainingTotal})},applyRecurringEntries(e){if(!this.state.monthlyData[e])return;let t=!1;const a=new Set,n=this.state.monthlyData[e];n.pfEntries.forEach(e=>{e.recurringId&&a.add(e.recurringId)}),n.pjEntries.forEach(e=>{e.recurringId&&a.add(e.recurringId)}),n.expenses.forEach(e=>{e.personalEntries.forEach(e=>{e.recurringId&&a.add(e.recurringId)}),e.businessEntries.forEach(e=>{e.recurringId&&a.add(e.recurringId)})}),this.state.recurringEntries.forEach(e=>{if(e.id&&!a.has(e.id)){const a=e.dayOfMonth-1;if(a<0||a>30)return;const s={id:Date.now()+Math.random(),description:e.description||"Lançamento recorrente",amount:e.amount,isRecurring:!0,recurringId:e.id};"Ganho PF"===e.type?(n.pfEntries.push(s),t=!0):"Ganho PJ"===e.type?(n.pjEntries.push(s),t=!0):"Gasto Pessoal"===e.type?(Object.assign(s,{category:e.category,paymentMethod:e.paymentMethod,card:e.card}),n.expenses[a].personalEntries.push(s),t=!0):"Gasto Empresa"===e.type&&(Object.assign(s,{category:"N/A",paymentMethod:e.paymentMethod,card:e.card}),n.expenses[a].businessEntries.push(s),t=!0)}}),t&&this.saveDataToFirestore()},exportMonthToCSV(e){const t=this.state.monthlyData[e];if(!t)return;const a=this.constants.monthNames[e],n=t.pjEntries.reduce((e,t)=>e+t.amount,0)+t.pfEntries.reduce((e,t)=>e+t.amount,0),s=t.expenses.flat().reduce((e,t)=>e+t.personalEntries.reduce((e,t)=>e+t.amount,0),0)+t.expenses.flat().reduce((e,t)=>e+t.businessEntries.reduce((e,t)=>e+t.amount,0),0),o=n-s;let r="data:text/csv;charset=utf-8,";r+=`Relatorio Financeiro - ${a}\r\n\r\n`,r+="Resumo do Mes\r\n",r+=`Total de Ganhos;${n.toFixed(2).replace(".",",")}\r\n`,r+=`Total de Gastos;${s.toFixed(2).replace(".",",")}\r\n`,r+=`Saldo Final;${o.toFixed(2).replace(".",",")}\r\n\r\n`,r+="Detalhes das Transacoes\r\n",r+="Tipo;Dia;Descricao;Valor;Categoria;Metodo de Pagamento;Cartao\r\n";const i=e=>`"${(e||"").replace(/"/g,'""')}"`;t.pjEntries.forEach(e=>r+=`Ganho PJ;;${i(e.description)};${e.amount.toFixed(2).replace(".",",")};;;\r\n`),t.pfEntries.forEach(e=>r+=`Ganho PF;;${i(e.description)};${e.amount.toFixed(2).replace(".",",")};;;\r\n`),t.expenses.forEach((e,t)=>{const a=(e,a)=>{e.forEach(e=>{let n=[a,t+1,i(e.description),e.amount.toFixed(2).replace(".",","),i(e.category),i(e.paymentMethod),i(e.card)].join(";");r+=n+"\r\n"})};a(e.personalEntries,"Gasto Pessoal"),a(e.businessEntries,"Gasto Empresa")});const d=document.createElement("a");d.setAttribute("href",encodeURI(r)),d.setAttribute("download",`relatorio_${a}.csv`),document.body.appendChild(d),d.click(),document.body.removeChild(d)},exportMonthToPDF(e){const t=this.state.monthlyData[e];if(!t)return;const{jsPDF:a}=window.jspdf,n=new a,s=this.constants.monthNames[e],o=n.internal.pageSize.height,r=n.internal.pageSize.width,i=e=>{e.saveGraphicsState(),e.setGState(new e.GState({opacity:.05})),e.setFontSize(40),e.setTextColor(200,200,200),e.setFont("helvetica","bold"),e.text("Rico Plus by Franzoi Tech",r/2,o/1.8,{angle:-45,align:"center"}),e.restoreGraphicsState()},d=e=>{n.setFontSize(16),n.setFont("helvetica","bold"),n.text("Relatório Financeiro",14,20),n.setFontSize(10),n.setFont("helvetica","normal"),n.text(`Período: ${s}`,14,26),n.setLineWidth(.5),n.line(14,30,r-14,30);const t=n.internal.getNumberOfPages();n.setFontSize(8),n.text(`Rico Plus by Franzoi Tech | Gerado em: ${(new Date).toLocaleString("pt-BR")}`,14,o-10),n.text(`Página ${e.pageNumber} de ${t}`,r-14,o-10,{align:"right"})},l=t.pjEntries.reduce((e,t)=>e+t.amount,0),c=t.pfEntries.reduce((e,t)=>e+t.amount,0),p=t.expenses.flat().reduce((e,t)=>e+t.personalEntries.reduce((e,t)=>e+t.amount,0),0),m=t.expenses.flat().reduce((e,t)=>e+t.businessEntries.reduce((e,t)=>e+t.amount,0),0),u=l+c-(p+m),h={};t.expenses.flat().forEach(e=>{e.personalEntries.forEach(e=>{h[e.category]=(h[e.category]||0)+e.amount})});const g=Object.keys(h).map(e=>[e,this.helpers.formatCurrency(h[e])]),y=[];t.pjEntries.forEach(e=>y.push(["-","Ganho PJ",e.description,"-","-",e.amount.toFixed(2).replace(".",",")])),t.pfEntries.forEach(e=>y.push(["-","Ganho PF",e.description,"-","-",e.amount.toFixed(2).replace(".",",")])),t.expenses.forEach((e,t)=>{e.personalEntries.forEach(e=>y.push([t+1,"Gasto Pessoal",e.description,e.category,`${e.paymentMethod}${e.card?` (${e.card})`:""}`,e.amount.toFixed(2).replace(".",",")])),e.businessEntries.forEach(e=>y.push([t+1,"Gasto Empresa",e.description,"-",`${e.paymentMethod}${e.card?` (${e.card})`:""}`,e.amount.toFixed(2).replace(".",",")]))});let b=40;n.autoTable({startY:b,head:[["Resumo Geral","Valor"]],body:[["Total Ganhos",this.helpers.formatCurrency(l+c)],["Total Gastos",this.helpers.formatCurrency(p+m)],[{content:"Saldo Final",styles:{fontStyle:"bold"}},{content:this.helpers.formatCurrency(u),styles:{fontStyle:"bold"}}]],theme:"grid",headStyles:{fillColor:[22,160,133]}}),b=n.lastAutoTable.finalY+10,g.length>0&&(n.autoTable({startY:b,head:[["Gastos por Categoria (Pessoal)","Total"]],body:g,theme:"striped",headStyles:{fillColor:[41,128,185]}}),b=n.lastAutoTable.finalY+10),n.autoTable({startY:b,head:[["Data","Tipo","Descrição","Cat.","Pag.","Valor (R$)"]],body:y,theme:"grid",didDrawPage:e=>{i(n),d(e)},headStyles:{fillColor:[44,62,80]},margin:{top:38,bottom:20}});const v=n.internal.getNumberOfPages();for(let e=1;e<=v;e++)n.setPage(e),i(n),d({pageNumber:e,pageCount:v});n.save(`relatorio_${s}.pdf`)},bindGlobalEventListeners(){this.debouncedSave=this.helpers.debounce(this.saveDataToFirestore,750);const e=document.getElementById("chatbot-modal"),t=e.querySelector(".modal-content");document.getElementById("floating-chatbot-btn").addEventListener("click",()=>{e.classList.remove("hidden"),setTimeout(()=>{e.style.opacity="1",t.style.transform="translateY(0)"},10)});document.getElementById("close-chatbot-modal-btn").addEventListener("click",()=>{e.style.opacity="0",t.style.transform="translateY(2rem)",setTimeout(()=>{e.classList.add("hidden")},300)}),document.getElementById("chatbot-send-btn").addEventListener("click",()=>{const e=document.getElementById("chatbot-input"),t=document.getElementById("chatbot-messages"),a=e.value.trim();a&&(t.innerHTML+=`\n                        <div class="flex justify-end">\n                            <div class="p-3 rounded-lg max-w-[85%] text-sm text-white" style="background-color: var(--primary-color);">\n                                <p class="font-bold mb-1">Você</p>\n                                <p>${a}</p>\n                            </div>\n                        </div>\n                    `,t.scrollTop=t.scrollHeight,setTimeout(()=>{t.innerHTML+='\n                            <div class="p-3 rounded-lg max-w-[85%] text-sm" style="background-color: var(--secondary-bg);">\n                                <p class="font-bold mb-1">Assistente</p>\n                                <p class="italic">Pensando...</p>\n                            </div>\n                        ',t.scrollTop=t.scrollHeight,App.ai.getChatbotResponse(a)},500),e.value="")}),document.getElementById("chatbot-input").addEventListener("keydown",e=>{"Enter"===e.key&&(e.preventDefault(),document.getElementById("chatbot-send-btn").click())}),document.getElementById("avatar-upload-input").addEventListener("change",this.handleAvatarUpload.bind(this)),themeToggleBtn.addEventListener("click",()=>{const e=document.documentElement.classList.contains("dark")?"light":"dark";localStorage.setItem("theme",e),applyTheme(e)}),document.getElementById("manage-settings-btn").addEventListener("click",()=>{this.render.renderSettingsModal()}),document.getElementById("close-modal-btn").addEventListener("click",()=>{this.ui.settingsModal.classList.add("hidden"),this.showMonth(this.state.activeMonthIndex)}),document.getElementById("manage-account-btn").addEventListener("click",()=>{this.render.renderAccountModal()}),document.getElementById("close-account-modal-btn").addEventListener("click",()=>{this.ui.accountModal.classList.add("hidden")}),document.getElementById("save-profile-btn").addEventListener("click",()=>{App.state.profile.name=App.ui.userNameInput.value,App.saveDataToFirestore(),App.ui.accountModal.classList.add("hidden"),App.helpers.showSaveFeedback(),App.render.updateHeader()}),document.getElementById("save-integration-btn").addEventListener("click",()=>{const e=App.state.integrations.whatsapp;e.phoneNumberId=App.ui.whatsappPhoneId.value,e.accessToken=App.ui.whatsappToken.value,e.webhookVerifyToken=App.ui.whatsappVerifyToken.value,App.saveDataToFirestore(),App.ui.accountModal.classList.add("hidden"),App.helpers.showSaveFeedback()}),document.getElementById("generate-verify-token-btn").addEventListener("click",()=>{const e=this.helpers.generateRandomToken();App.ui.whatsappVerifyToken.value=e}),document.getElementById("copy-webhook-url-btn").addEventListener("click",e=>{navigator.clipboard.writeText(App.ui.whatsappWebhookUrl.value),e.target.textContent="Copiado!",setTimeout(()=>{e.target.textContent="Copiar"},2e3)}),document.getElementById("close-ai-modal-btn").addEventListener("click",()=>{this.ui.aiAnalysisModal.classList.add("hidden")}),document.getElementById("add-card-btn").addEventListener("click",()=>{const e=this.ui.newCardNameInput.value.trim();e&&!this.state.creditCards.includes(e)&&(this.state.creditCards.push(e),this.ui.newCardNameInput.value="",this.render.renderCardList(),this.saveDataToFirestore())}),document.getElementById("add-category-btn").addEventListener("click",()=>{const e=this.ui.newCategoryNameInput.value.trim(),t=e.toLowerCase();e&&!this.state.categories.some(e=>e.name.toLowerCase()===t)?(this.state.categories.push({name:e,budget:0}),this.ui.newCategoryNameInput.value="",this.render.renderCategoryList(),this.saveDataToFirestore()):e&&alert("Já existe uma categoria com este nome.")}),document.getElementById("recurring-type").addEventListener("change",e=>{document.getElementById("recurring-expense-fields").classList.toggle("hidden",!e.target.value.includes("Gasto"))}),document.getElementById("recurring-payment").addEventListener("change",e=>{document.getElementById("recurring-card").classList.toggle("hidden","Crédito"!==e.target.value)}),document.getElementById("add-recurring-btn").addEventListener("click",()=>{const e={id:Date.now(),description:document.getElementById("recurring-desc").value,amount:parseFloat(document.getElementById("recurring-amount").value)||0,dayOfMonth:parseInt(document.getElementById("recurring-day").value)||1,type:document.getElementById("recurring-type").value};!e.description||e.amount<=0?alert("Preencha descrição e valor."):(e.type.includes("Gasto")&&(e.category=document.getElementById("recurring-category").value,e.paymentMethod=document.getElementById("recurring-payment").value,e.card="Crédito"===e.paymentMethod?document.getElementById("recurring-card").value:""),this.state.recurringEntries.push(e),this.render.renderRecurringList(),this.saveDataToFirestore(),document.getElementById("recurring-form").querySelectorAll("input, select").forEach(e=>e.value=""))}),document.body.addEventListener("click",e=>{const t=e.target,a=t.closest('.calendar-nav-btn, [data-action="show-annual"]');if(a){const e=a.dataset.action,t=App.state.activeMonthIndex;if("show-annual"===e)App.state.lastViewedMonthIndex=t,App.showMonth(12);else if("prev-month"===e){const e=(t-1+12)%12;App.showMonth(e)}else if("next-month"===e){const e=(t+1)%12;App.showMonth(e)}return}const n=t.closest(".calendar-day.current-month");if(n){const e=parseInt(n.dataset.day),t=App.state.activeMonthIndex,a=document.querySelectorAll(`#expense-accordion-container-${t} .accordion-item`),s=a[e],o=n.classList.contains("active");document.querySelectorAll(`#calendar-container-${t} .calendar-day.active`).forEach(e=>e.classList.remove("active")),a.forEach(e=>e.classList.remove("active")),o||(n.classList.add("active"),s&&s.classList.add("active"))}if(t.matches(".tab-button")&&this.showMonth(parseInt(t.dataset.monthIndex)),t.matches(".export-csv-btn")&&this.exportMonthToCSV(parseInt(t.dataset.monthIndex)),t.matches(".export-pdf-btn")&&this.exportMonthToPDF(parseInt(t.dataset.monthIndex)),t.matches("#copy-pix-btn")){const e=document.getElementById("pix-key").textContent;navigator.clipboard.writeText(e).then(()=>{t.textContent="Copiado!",setTimeout(()=>{t.textContent="Copiar"},2e3)})}if(t.closest(".accordion-trigger")){const e=t.closest(".accordion-trigger").parentElement,a=e.parentElement.querySelectorAll(".accordion-item");e.classList.contains("active")?e.classList.remove("active"):(a.forEach(e=>e.classList.remove("active")),e.classList.add("active"))}if(t.closest(".ai-analysis-btn")&&this.ai.getFinancialAnalysis(parseInt(t.closest(".ai-analysis-btn").dataset.monthIndex)),t.matches("#ai-annual-analysis-btn")&&this.ai.getAnnualFinancialAnalysis(),t.closest(".suggest-category-btn")){const e=t.closest(".suggest-category-btn"),a=e.closest(".expense-entry-row");if(a){const t=a.querySelector(".remove-btn").dataset.entryId,n=a.querySelector('[data-field="description"]');n&&n.value&&this.ai.getCategorySuggestion(n.value,t,e)}}if(t.matches(".add-entry-btn")){const{monthIndex:e,type:a,day:n,category:s}=t.dataset,o=parseInt(e),r="pj"===a?this.state.monthlyData[o].pjEntries:"pf"===a?this.state.monthlyData[o].pfEntries:this.state.monthlyData[o].expenses[parseInt(n)][`${s}Entries`];if("pj"===a||"pf"===a){const e={id:Date.now(),description:"",amount:0};r.push(e),document.getElementById(`${a}-entries-container-${o}`).appendChild(this.render.createEntryElement({monthIndex:o,entry:e,type:a}))}else if("expense"===a){const e={id:Date.now(),description:"",amount:0,paymentMethod:"Pix",card:this.state.creditCards.length>0?this.state.creditCards[0]:"",category:this.state.categories[0].name};r.push(e),document.getElementById(`${s}-entries-${o}-${n}`).appendChild(this.render.createEntryElement({monthIndex:o,dayIndex:parseInt(n),category:s,entry:e,type:"expense"}))}this.recalculateAndDisplayTotals(o),this.saveDataToFirestore()}if(t.matches(".remove-btn")){const{monthIndex:e,type:a,day:n,category:s,entryId:o}=t.dataset,r=parseInt(e),i=parseFloat(o);"pj"===a?this.state.monthlyData[r].pjEntries=this.state.monthlyData[r].pjEntries.filter(e=>e.id!==i):"pf"===a?this.state.monthlyData[r].pfEntries=this.state.monthlyData[r].pfEntries.filter(e=>e.id!==i):this.state.monthlyData[r].expenses[parseInt(n)][`${s}Entries`]=this.state.monthlyData[r].expenses[parseInt(n)][`${s}Entries`].filter(e=>e.id!==i),t.closest(".expense-entry-row").remove(),this.recalculateAndDisplayTotals(r),this.saveDataToFirestore()}if(t.matches(".remove-card-btn")){const e=t.dataset.cardName;for(let t=0;t<12;t++)this.state.monthlyData[t].expenses.forEach(t=>{[...t.personalEntries,...t.businessEntries].forEach(t=>{t.card===e&&(t.card="Cartão Removido")})});this.state.creditCards=this.state.creditCards.filter(t=>t!==e),this.render.renderCardList(),this.saveDataToFirestore()}if(t.matches(".remove-category-btn")){const e=t.dataset.categoryName;for(let t=0;t<12;t++)this.state.monthlyData[t].expenses.forEach(t=>{t.personalEntries.forEach(t=>{t.category===e&&(t.category="Outros")})});this.state.categories=this.state.categories.filter(t=>t.name!==e),this.render.renderCategoryList(),this.saveDataToFirestore()}if(t.matches(".remove-recurring-btn")){const e=parseInt(t.dataset.index);this.state.recurringEntries.splice(e,1),this.render.renderRecurringList(),this.saveDataToFirestore()}if(t.matches('[data-action="back-to-months"]')){const e=App.state.lastViewedMonthIndex;"number"==typeof e?App.showMonth(e):App.showMonth((new Date).getMonth())}}),document.body.addEventListener("input",e=>{const t=e.target;if(t.matches(".entry-input")){const e=t.closest(".expense-entry-row").querySelector(".remove-btn");if(!e)return;const{monthIndex:a,type:n,day:s,category:o,entryId:r}=e.dataset,i=parseInt(a),d=parseFloat(r);let l;if(l="pj"===n?this.state.monthlyData[i].pjEntries.find(e=>e.id===d):"pf"===n?this.state.monthlyData[i].pfEntries.find(e=>e.id===d):this.state.monthlyData[i].expenses[parseInt(s)][`${o}Entries`].find(e=>e.id===d),l){const e=t.dataset.field;"amount"===e?l.amount=parseFloat(t.value)||0:l[e]=t.value,"paymentMethod"===e?this.showMonth(i):this.recalculateAndDisplayTotals(i),this.debouncedSave()}}if(t.matches(".category-budget-input")){const e=this.state.categories.find(e=>e.name===t.dataset.categoryName);e&&(e.budget=parseFloat(t.value)||0,this.debouncedSave())}}),document.body.addEventListener("change",e=>{const t=e.target;if(t.matches(".category-name-input")){const e=t.dataset.oldName,a=t.value.trim(),n=a.toLowerCase(),s=e.toLowerCase(),o=this.state.categories.some(e=>e.name.toLowerCase()===n);if(a&&s!==n&&!o){for(let e=0;e<12;e++)this.state.monthlyData[e].expenses.forEach(e=>{e.personalEntries.forEach(e=>{e.category.toLowerCase()===s&&(e.category=a)})});const e=this.state.categories.find(e=>e.name.toLowerCase()===s);e&&(e.name=a),t.dataset.oldName=a,this.state.recurringEntries.forEach(e=>{e.category.toLowerCase()===s&&(e.category=a)}),this.saveDataToFirestore()}else o&&s!==n&&(alert("Já existe uma categoria com este nome."),t.value=e)}})},ai:{async getFinancialAnalysis(e){App.ui.aiAnalysisModal.classList.remove("hidden"),App.ui.aiAnalysisResult.innerHTML='<p class="muted-text">Analisando seus dados...</p>';try{const t=App.state.monthlyData[e];if(!t)throw new Error("Dados do mês não encontrados.");const a=`\n                            **Contexto, Regras e Funcionalidades do App:**\n                            1. Você é o assistente de IA da plataforma "Rico Plus".\n                            2. Você pode dar dicas financeiras gerais, mas ao sugerir ações, SÓ PODE usar as funcionalidades existentes.\n                            3. Funcionalidades existentes: Lançamento de ganhos/despesas, categorização, metas de gastos, resumos, gráficos, lançamentos recorrentes, gestão de cartões, exportação PDF/CSV.\n                            4. **NÃO INVENTE** funcionalidades que não existem (ex: notificações).\n                            5. **NUNCA** mencione apps concorrentes.\n\n                            **Tarefa:**\n                            Gere um relatório em HTML (sem texto fora do HTML) analisando os dados: ${JSON.stringify(t)}.\n                            O relatório deve conter:\n                            1. Um resumo dos ganhos e gastos.\n                            2. A maior categoria de despesa pessoal.\n                            3. Três sugestões práticas para melhorar a saúde financeira, baseadas nas funcionalidades existentes do Rico Plus.\n                        `,n=await this.callVercelFunction(a),s=App.helpers.cleanAIResponse(n);App.ui.aiAnalysisResult.innerHTML=s}catch(e){console.error("Erro ao obter análise da IA:",e),App.ui.aiAnalysisResult.innerHTML='<p style="color: var(--red-color);">Ocorreu um erro ao tentar analisar os dados.</p>'}},async getAnnualFinancialAnalysis(){App.ui.aiAnalysisModal.classList.remove("hidden"),App.ui.aiAnalysisResult.innerHTML='<p class="muted-text">Analisando seus dados anuais...</p>';try{const e=App.state.monthlyData;if(!e)throw new Error("Dados anuais não encontrados.");const t=`\n                            **Contexto, Regras e Funcionalidades do App:**\n                            1. Você é o assistente de IA da plataforma "Rico Plus".\n                            2. Você pode dar dicas financeiras gerais, mas ao sugerir ações, SÓ PODE usar as funcionalidades existentes.\n                            3. Funcionalidades existentes: Lançamento de ganhos/despesas, categorização, metas de gastos, resumos, gráficos, lançamentos recorrentes, gestão de cartões, exportação PDF/CSV.\n                            4. **NÃO INVENTE** funcionalidades que não existem (ex: notificações).\n                            5. **NUNCA** mencione apps concorrentes.\n\n                            **Tarefa:**\n                            Gere um relatório em HTML (sem texto fora do HTML) analisando os dados anuais: ${JSON.stringify(e)}.\n                            O relatório deve conter:\n                            1. Um resumo geral dos ganhos, gastos e saldo final do ano.\n                            2. O mês de maior gasto e o mês de maior ganho.\n                            3. Três insights estratégicos para o próximo ano.\n                        `,a=await this.callVercelFunction(t),n=App.helpers.cleanAIResponse(a);App.ui.aiAnalysisResult.innerHTML=n}catch(e){console.error("Erro ao obter análise anual da IA:",e),App.ui.aiAnalysisResult.innerHTML='<p style="color: var(--red-color);">Ocorreu um erro ao tentar analisar os dados anuais.</p>'}},async getChatbotResponse(e){try{const t=App.state.monthlyData,a=`\n                            **Contexto, Regras e Funcionalidades do App:**\n                            1. Você é o assistente de IA da plataforma "Rico Plus". Sua personalidade é prestativa e focada em ajudar.\n                            2. Você pode dar dicas financeiras gerais e conceituais (ex: importância de poupar).\n                            3. **REGRA CRÍTICA:** Ao sugerir uma AÇÃO PRÁTICA ou FERRAMENTA, você SÓ PODE se basear na seguinte lista de funcionalidades que REALMENTE EXISTEM no Rico Plus:\n                                - Lançamento de ganhos (PJ/PF) e despesas.\n                                - Categorização de gastos e definição de metas de orçamento.\n                                - Resumos, saldos e gráficos.\n                                - Lançamentos recorrentes.\n                                - Gerenciamento de cartões de crédito.\n                            4. **NÃO INVENTE** funcionalidades que não estão na lista (ex: notificações).\n                            5. **NUNCA** mencione apps concorrentes. Se o usuário pedir uma ferramenta, reforce o uso do Rico Plus.\n\n                            **Tarefa:**\n                            Responda à pergunta do usuário: "${e}". Use os dados financeiros a seguir como base: ${JSON.stringify(t)}.\n                            Formate sua resposta de forma clara usando Markdown.\n                        `,n=await this.callVercelFunction(a),s=document.getElementById("chatbot-messages");s.removeChild(s.lastChild);const o=marked.parse(n);s.innerHTML+=`\n                            <div class="p-3 rounded-lg max-w-[85%] text-sm" style="background-color: var(--secondary-bg);">\n                                <p class="font-bold mb-1">Assistente</p>\n                                <div class="prose dark:prose-invert max-w-none">${o}</div>\n                            </div>\n                        `,s.scrollTop=s.scrollHeight}catch(e){console.error("Erro na resposta do chatbot:",e);const t=document.getElementById("chatbot-messages");t.removeChild(t.lastChild),t.innerHTML+='\n                            <div class="p-3 rounded-lg max-w-[85%] text-sm" style="background-color: var(--secondary-bg);">\n                                <p class="font-bold mb-1">Assistente</p>\n                                <p>Desculpe, não consegui processar sua pergunta. Tente novamente.</p>\n                            </div>\n                        ',t.scrollTop=t.scrollHeight}},async getCategorySuggestion(e,t,a){const n=a.innerHTML;a.innerHTML="...",a.disabled=!0;try{const t=`\n                        Analise a despesa: "${e}".\n                        Qual das seguintes categorias melhor se encaixa? Categorias disponíveis: [${App.state.categories.map(e=>e.name).join(", ")}].\n                        Responda APENAS com o nome exato de uma das categorias da lista. Sem frases, apenas a categoria.\n                    `;let n=await this.callVercelFunction(t);n=n.trim().replace(/["'.]/g,"");const s=a.closest(".expense-entry-row").querySelector('[data-field="category"]'),o=App.state.categories.find(e=>e.name.toLowerCase()===n.toLowerCase());if(s&&o){s.value=o.name;const e=new Event("input",{bubbles:!0});s.dispatchEvent(e)}else console.warn(`Categoria sugerida "${n}" não é válida ou não foi encontrada.`)}catch(e){console.error("Erro ao obter sugestão de categoria:",e)}finally{a.innerHTML=n,a.disabled=!1}},async callVercelFunction(e){const t=await fetch("https://controledegastos1-0.vercel.app/api/analyze",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({prompt:e})});if(!t.ok)throw new Error(`Erro na API da Vercel: ${t.statusText}`);return(await t.json()).analysis}},render:{updateHeader(){const e=App.state.profile.name?.split(" ")[0]||"Visitante";document.getElementById("greeting-text").textContent=`Olá, ${e}`;const t=(new Date).getHours();let a="Tenha um ótimo dia!";a=t>=5&&t<12?"Bom dia!":t>=12&&t<18?"Boa tarde!":"Boa noite!",document.getElementById("time-greeting").textContent=a;const n=App.state.profile.avatarUrl||"images/default-avatar.svg";document.getElementById("user-avatar").src=n},renderCalendarView(e){const t=document.getElementById(`calendar-container-${e}`);if(!t)return;const a=(new Date).getFullYear(),n=new Date(a,e,1),s=new Date(a,e+1,0),o=n.getDay();let r=`\n                    <div class="calendar-nav-header flex items-center justify-between mb-4 p-2 rounded-xl" style="background-color: var(--input-bg);">\n                        <button class="calendar-nav-btn" data-action="prev-month" title="Mês Anterior">‹</button>\n                        <div class="flex flex-col sm:flex-row items-center gap-1 sm:gap-4">\n                            <h3 class="text-lg font-semibold text-center">${App.constants.monthNames[e]} ${a}</h3>\n                            <button class="px-3 py-1 text-xs font-semibold rounded-lg" style="background-color: var(--secondary-bg); color: var(--secondary-text);" data-action="show-annual">Balanço Anual</button>\n                        </div>\n                        <button class="calendar-nav-btn" data-action="next-month" title="Próximo Mês">›</button>\n                    </div>\n                `,i='<div class="calendar-grid">';["Dom","Seg","Ter","Qua","Qui","Sex","Sáb"].forEach(e=>{i+=`<div class="calendar-header">${e}</div>`});for(let e=0;e<o;e++)i+="<div></div>";for(let t=1;t<=s.getDate();t++){const a=App.state.monthlyData[e].expenses[t-1];let n="calendar-day current-month";a&&(a.personalEntries.length>0||a.businessEntries.length>0)&&(n+=" has-entries"),i+=`<div class="${n}" data-day="${t-1}">${t}</div>`}i+="</div>",t.innerHTML=r+i},createMonthContentHTML:e=>`<div id="month-${e}-content" class="month-content">\n                    <div class="flex justify-end gap-2 mb-4">\n                        <button class="export-csv-btn px-4 py-2 text-sm font-semibold rounded-lg" style="background-color: var(--secondary-bg); color: var(--secondary-text);" data-month-index="${e}">Exportar CSV</button>\n                        <button class="export-pdf-btn px-4 py-2 text-sm font-semibold rounded-lg" style="background-color: var(--secondary-bg); color: var(--secondary-text);" data-month-index="${e}">Exportar PDF</button>\n                    </div>\n                    <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 mb-8">\n                        <div class="lg:col-span-1 p-5 rounded-2xl card border-t-4 border-yellow-400">\n                            <h2 class="text-xl font-semibold mb-4">Ganhos Pessoa Jurídica</h2>\n                            <div id="pj-entries-container-${e}" class="flex flex-col gap-3 mb-3"></div>\n                            <button class="add-entry-btn mt-2 w-full py-2 text-sm font-semibold rounded-lg" style="background-color: var(--secondary-bg); color: var(--secondary-text);" data-month-index="${e}" data-type="pj">+ Adicionar Ganho PJ</button>\n                        </div>\n                        <div class="lg:col-span-1 p-5 rounded-2xl card border-t-4 border-green-400">\n                            <h2 class="text-xl font-semibold mb-4">Ganhos Pessoa Física</h2>\n                            <div id="pf-entries-container-${e}" class="flex flex-col gap-3 mb-3"></div>\n                            <button class="add-entry-btn mt-2 w-full py-2 text-sm font-semibold rounded-lg" style="background-color: var(--secondary-bg); color: var(--secondary-text);" data-month-index="${e}" data-type="pf">+ Adicionar Ganho PF</button>\n                        </div>\n                        <div class="lg:col-span-1 grid gap-6">\n                            <div>\n                                <div class="p-5 rounded-2xl card border-t-4 border-blue-400 space-y-4">\n                                    <div class="space-y-1"><label class="block text-sm font-medium muted-text">Caixa da empresa:</label><p id="companyCash-${e}" class="text-2xl font-semibold">R$ 0,00</p></div>\n                                    <div class="space-y-1"><label class="block text-sm font-medium muted-text">Caixa pessoal:</label><p id="personalCash-${e}" class="text-2xl font-semibold">R$ 0,00</p></div>\n                                </div>\n                            </div>\n                            <div>\n                                <div id="summary-card-${e}" class="p-5 rounded-2xl card border-t-4 border-purple-400">\n                                    <h2 class="text-xl font-semibold mb-4">Resumo do Mês</h2>\n                                    <div class="space-y-2 text-sm">\n                                        <div class="flex justify-between items-center"><span>Gasto Pessoal:</span><span id="totalPersonalExpenses-${e}" class="font-semibold" style="color: var(--red-color);">R$ 0,00</span></div>\n                                        <div class="flex justify-between items-center"><span>Gasto Empresa:</span><span id="totalBusinessExpenses-${e}" class="font-semibold" style="color: var(--red-color);">R$ 0,00</span></div>\n                                        <div class="flex justify-between items-center pt-2 border-t" style="border-color: var(--border-color);"><span>Saldo Pessoal:</span><span id="remainingPersonal-${e}" class="font-semibold">R$ 0,00</span></div>\n                                        <div class="flex justify-between items-center"><span>Saldo Empresa:</span><span id="remainingBusiness-${e}" class="font-semibold">R$ 0,00</span></div>\n                                        <div class="flex justify-between items-center border-t pt-2 mt-2" style="border-color: var(--border-color);"><span class="font-semibold">Saldo Total:</span><span id="remainingTotal-${e}" class="text-xl font-bold">R$ 0,00</span></div>\n                                    </div>\n                                    <div id="budget-alerts-${e}" class="mt-3 text-xs"></div>\n                                </div>\n                            </div>\n                        </div>\n                    </div>\n                    <div class="text-center mb-4"><button class="ai-analysis-btn px-5 py-2 text-white font-semibold rounded-xl shadow-sm transition-colors" style="background-color: var(--primary-color);" onmouseover="this.style.backgroundColor=getComputedStyle(this).getPropertyValue('--primary-color-hover')" onmouseout="this.style.backgroundColor=getComputedStyle(this).getPropertyValue('--primary-color')" data-month-index="${e}">Analisar Mês com IA ✨</button></div>\n                    <div id="calendar-container-${e}" class="mb-8"></div>\n                    <div id="expense-section-wrapper-${e}" class=""><div id="expense-accordion-container-${e}" class="space-y-2 mb-8"></div></div>\n                    <div class="grid grid-cols-1 xl:grid-cols-3 gap-6 mt-8">\n                        <div class="card p-6 rounded-2xl">\n                            <h2 class="text-xl font-semibold text-center mb-4">Balanço do Mês</h2>\n                            <div class="relative mx-auto" style="max-width: 300px; height: 300px;"><canvas id="budgetPieChart-${e}"></canvas></div>\n                        </div>\n                        <div class="card p-6 rounded-2xl">\n                            <h2 class="text-xl font-semibold text-center mb-4">Gastos por Pagamento</h2>\n                            <div class="relative mx-auto" style="max-width: 300px; height: 300px;"><canvas id="paymentMethodChart-${e}"></canvas></div>\n                        </div>\n                        <div class="card p-6 rounded-2xl">\n                            <h2 class="text-xl font-semibold text-center mb-4">Metas de Gastos (Pessoal)</h2>\n                            <div class="relative mx-auto" style="height: 300px;"><canvas id="budgetGoalsChart-${e}"></canvas></div>\n                        </div>\n                    </div>\n                </div>`,createBalanceContentHTML:()=>'<div id="month-12-content" class="month-content">\n                    <div class="flex items-center justify-center gap-4 mb-8">\n                        <h2 class="text-3xl font-bold">Balanço Anual</h2>\n                        <button class="px-3 py-1.5 text-sm font-semibold rounded-lg" style="background-color: var(--secondary-bg); color: var(--secondary-text);" data-action="back-to-months">← Voltar</button>\n                    </div>\n                    <div class="text-center mb-8 -mt-4"><button id="ai-annual-analysis-btn" class="px-5 py-2 text-white font-semibold rounded-xl shadow-sm transition-colors" style="background-color: var(--primary-color);">Analisar Ano com IA ✨</button></div>\n                    <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-4 gap-6 mb-8 text-center">\n                        <div class="card border-t-4 border-yellow-400 p-5 rounded-2xl"><span class="block text-sm muted-text mb-2">Total Ganhos PJ</span><span id="totalAnnualPJ" class="text-2xl font-semibold">R$ 0,00</span></div>\n                        <div class="card border-t-4 border-green-400 p-5 rounded-2xl"><span class="block text-sm muted-text mb-2">Total Ganhos PF</span><span id="totalAnnualPF" class="text-2xl font-semibold">R$ 0,00</span></div>\n                        <div class="card border-t-4 border-red-400 p-5 rounded-2xl"><span class="block text-sm muted-text mb-2">Gastos Totais</span><span id="totalAnnualExpenses" class="text-2xl font-semibold">R$ 0,00</span></div>\n                        <div class="card border-t-4 border-blue-400 p-5 rounded-2xl"><span class="block text-sm muted-text mb-2">Saldo Final</span><span id="annualBalance" class="text-2xl font-bold">R$ 0,00</span><p id="annualPerformance" class="text-lg font-semibold mt-1"></p></div>\n                    </div>\n                    <div class="grid grid-cols-1 lg:grid-cols-2 gap-6">\n                        <div class="card p-6 rounded-2xl lg:col-span-2">\n                            <h3 class="text-xl font-semibold text-center mb-4">Desempenho Mensal</h3>\n                            <div class="relative mx-auto" style="height: 400px;"><canvas id="monthlyPerformanceBarChart"></canvas></div>\n                        </div>\n                        <div class="card p-6 rounded-2xl">\n                            <h3 class="text-xl font-semibold text-center mb-4">Maiores Gastos do Ano (Top 5)</h3>\n                            <div id="top-spends-container" class="text-sm space-y-2 max-h-96 overflow-y-auto p-2"></div>\n                        </div>\n                    </div>\n                </div>',createEntryElement:e=>{const{monthIndex:t,dayIndex:a,category:n,entry:s,type:o}=e,r=document.createElement("div");r.classList.add("flex","items-center","gap-2","w-full","flex-wrap","expense-entry-row");let i="",d="",l="",c="",p="";return"expense"===o?(i=`<button class="remove-btn" data-type="expense" data-month-index="${t}" data-day="${a}" data-category="${n}" data-entry-id="${s.id}">×</button>`,d=`<select class="entry-input p-2 input-field text-sm w-full sm:w-auto" data-field="paymentMethod">${App.constants.basePaymentMethods.map(e=>`<option value="${e}" ${s.paymentMethod===e?"selected":""}>${e}</option>`).join("")}</select>`,"Crédito"===s.paymentMethod&&(l=`<select class="entry-input p-2 input-field text-sm w-full sm:w-auto" data-field="card">${App.state.creditCards.map(e=>`<option value="${e}" ${s.card===e?"selected":""}>${e}</option>`).join("")}</select>`),c=`<select class="entry-input p-2 input-field text-sm w-full sm:w-auto" data-field="category">${App.state.categories.map(e=>`<option value="${e.name}" ${s.category===e.name?"selected":""}>${e.name}</option>`).join("")}</select>`,p='<div class="tooltip-container"><button class="suggest-category-btn flex-shrink-0 flex items-center justify-center h-10 w-10 rounded-xl" style="background-color: var(--secondary-bg); color: var(--secondary-text);">✨</button><span class="tooltip-text">Sugerir categoria com IA</span></div>'):i=`<button class="remove-btn" data-type="${o}" data-month-index="${t}" data-entry-id="${s.id}">×</button>`,r.innerHTML=`<input type="text" value="${s.description}" placeholder="Descrição" class="entry-input flex-grow p-2 input-field text-sm" data-field="description"><input type="number" value="${s.amount}" min="0" step="0.01" placeholder="0,00" class="entry-input w-28 p-2 input-field text-sm" data-field="amount">${c}${p}${d}<span class="card-selector-container">${l}</span>${i}`,r},renderPJEntries:e=>{const t=document.getElementById(`pj-entries-container-${e}`);t&&(t.innerHTML="",App.state.monthlyData[e].pjEntries.forEach(a=>t.appendChild(App.render.createEntryElement({monthIndex:e,entry:a,type:"pj"}))))},renderPFEntries:e=>{const t=document.getElementById(`pf-entries-container-${e}`);t&&(t.innerHTML="",App.state.monthlyData[e].pfEntries.forEach(a=>t.appendChild(App.render.createEntryElement({monthIndex:e,entry:a,type:"pf"}))))},renderExpenseTable:e=>{const t=document.getElementById(`expense-accordion-container-${e}`);if(t){t.innerHTML="";for(let a=0;a<31;a++){const n=document.createElement("div");n.className="accordion-item card rounded-xl overflow-hidden",n.innerHTML=`<div class="accordion-trigger flex justify-between items-center p-4 cursor-pointer" style="background-color: var(--input-bg);"><span class="font-semibold">Dia ${a+1}</span><span class="arrow text-xl muted-text">▼</span></div><div class="accordion-content"><div class="grid grid-cols-1 md:grid-cols-2 gap-6"><div><h3 class="font-semibold mb-3">Gastos Pessoais</h3><div id="personal-entries-${e}-${a}" class="flex flex-col gap-3"></div><button class="add-entry-btn mt-3 px-3 py-1.5 text-sm font-semibold rounded-lg" style="background-color: var(--secondary-bg); color: var(--secondary-text);" data-month-index="${e}" data-day="${a}" data-type="expense" data-category="personal">+ Gasto Pessoal</button></div><div><h3 class="font-semibold mb-3">Gastos da Empresa</h3><div id="business-entries-${e}-${a}" class="flex flex-col gap-3"></div><button class="add-entry-btn mt-3 px-3 py-1.5 text-sm font-semibold rounded-lg" style="background-color: var(--secondary-bg); color: var(--secondary-text);" data-month-index="${e}" data-day="${a}" data-type="expense" data-category="business">+ Gasto Empresa</button></div></div></div>`,t.appendChild(n),["personal","business"].forEach(t=>{const s=n.querySelector(`#${t}-entries-${e}-${a}`);App.state.monthlyData[e].expenses[a][`${t}Entries`].forEach(n=>s.appendChild(App.render.createEntryElement({monthIndex:e,dayIndex:a,category:t,entry:n,type:"expense"})))})}}},updateBudgetAlerts:e=>{const t=document.getElementById(`budget-alerts-${e}`);if(!t)return;const a=App.state.categories.reduce((e,t)=>({...e,[t.name]:0}),{});App.state.monthlyData[e].expenses.forEach(e=>{e.personalEntries.forEach(e=>{void 0!==a[e.category]&&(a[e.category]+=e.amount)})});const n=App.state.categories.map(e=>a[e.name]>e.budget&&e.budget>0?`<li style="color: var(--red-color);">${e.name}: ${App.helpers.formatCurrency(a[e.name]-e.budget)} acima da meta.</li>`:"").filter(Boolean);t.innerHTML=n.length>0?`<p class="font-semibold mt-2">Atenção ao Orçamento:</p><ul class="list-disc list-inside ml-4">${n.join("")}</ul>`:""},updateAllCharts:(e,t)=>{const a=getComputedStyle(document.documentElement).getPropertyValue("--text-color"),n=getComputedStyle(document.documentElement).getPropertyValue("--border-color"),s={responsive:!0,maintainAspectRatio:!1,plugins:{legend:{labels:{color:a,font:{family:"Inter"}}}}},o={...s,scales:{y:{ticks:{color:a},grid:{color:n}},x:{ticks:{color:a},grid:{color:n}}}};App.state.chartInstances.pie&&App.state.chartInstances.pie.destroy(),App.state.chartInstances.pie=new Chart(document.getElementById(`budgetPieChart-${e}`).getContext("2d"),{type:"pie",data:{labels:["Pessoais","Empresa","Saldo"],datasets:[{data:[t.totalPersonal,t.totalBusiness,Math.max(0,t.remainingBudget)],backgroundColor:["#ff453a","#32d74b","#2997ff"]}]},options:s});const r=[...App.constants.basePaymentMethods.filter(e=>"Crédito"!==e),...App.state.creditCards.map(e=>`Crédito (${e})`)],i=Object.fromEntries(r.map(e=>[e,0]));App.state.monthlyData[e].expenses.forEach(e=>{[...e.personalEntries,...e.businessEntries].forEach(e=>{let t="Crédito"===e.paymentMethod?`Crédito (${e.card})`:e.paymentMethod;void 0!==i[t]&&(i[t]+=e.amount)})});App.state.chartInstances.payment&&App.state.chartInstances.payment.destroy(),App.state.chartInstances.payment=new Chart(document.getElementById(`paymentMethodChart-${e}`).getContext("2d"),{type:"doughnut",data:{labels:r,datasets:[{data:Object.values(i),backgroundColor:["#007BFF","#FD7E14","#DC3545","#20C997","#6F42C1","#D63384","#198754","#6C757D"],borderColor:getComputedStyle(document.documentElement).getPropertyValue("--card-bg"),borderWidth:2}]},options:s});const d=App.state.categories.reduce((e,t)=>({...e,[t.name]:0}),{});App.state.monthlyData[e].expenses.forEach(e=>{e.personalEntries.forEach(e=>{void 0!==d[e.category]&&(d[e.category]+=e.amount)})});const l=App.state.categories.map(e=>d[e.name]),c=App.state.categories.map(e=>e.budget),p=l.map((e,t)=>e>c[t]&&c[t]>0?"#ff9500":"#ff453a");App.state.chartInstances.goals&&App.state.chartInstances.goals.destroy(),App.state.chartInstances.goals=new Chart(document.getElementById(`budgetGoalsChart-${e}`).getContext("2d"),{type:"bar",data:{labels:App.state.categories.map(e=>e.name),datasets:[{label:"Gasto",data:l,backgroundColor:p},{label:"Meta",data:c,backgroundColor:"#2997ff"}]},options:{...o,indexAxis:"y"}})},renderBalanceSummary:()=>{let e={pj:0,pf:0,personal:0,business:0},t={gains:[],expenses:[]},a=[];for(let n=0;n<12;n++){if(!App.state.monthlyData[n]){t.gains.push(0),t.expenses.push(0);continue}const s=App.state.monthlyData[n];let o=0,r=0;s.pjEntries.forEach(t=>{e.pj+=t.amount,o+=t.amount}),s.pfEntries.forEach(t=>{e.pf+=t.amount,o+=t.amount}),s.expenses.forEach(t=>{t.personalEntries.forEach(t=>{e.personal+=t.amount,r+=t.amount,t.amount>0&&a.push({...t,month:n})}),t.businessEntries.forEach(t=>{e.business+=t.amount,r+=t.amount})}),t.gains.push(o),t.expenses.push(r)}const n=e.pj+e.pf-(e.personal+e.business);document.getElementById("totalAnnualPJ").textContent=App.helpers.formatCurrency(e.pj),document.getElementById("totalAnnualPF").textContent=App.helpers.formatCurrency(e.pf),document.getElementById("totalAnnualExpenses").textContent=App.helpers.formatCurrency(e.personal+e.business),document.getElementById("annualBalance").textContent=App.helpers.formatCurrency(n);const s=document.getElementById("annualPerformance");s.textContent=n>=0?"Positivo":"Negativo",s.style.color=n>=0?"var(--green-color)":"var(--red-color)";const o=a.sort((e,t)=>t.amount-e.amount).slice(0,5);document.getElementById("top-spends-container").innerHTML=o.map(e=>`<div class="p-2 rounded-lg" style="background-color: var(--input-bg);"><strong class="text-color">${e.category}:</strong> ${App.helpers.formatCurrency(e.amount)} <span class="text-xs muted-text">(${e.description} em ${App.constants.monthNames[e.month]})</span></div>`).join("")||'<p class="muted-text">Nenhum gasto pessoal registrado.</p>',App.render.updateAnnualCharts(t)},updateAnnualCharts:e=>{const t=getComputedStyle(document.documentElement).getPropertyValue("--text-color"),a=getComputedStyle(document.documentElement).getPropertyValue("--border-color"),n={responsive:!0,maintainAspectRatio:!1,plugins:{legend:{labels:{color:t}}},scales:{y:{ticks:{color:t},grid:{color:a}},x:{ticks:{color:t},grid:{color:a}}}};App.state.chartInstances.annualBar&&App.state.chartInstances.annualBar.destroy(),App.state.chartInstances.annualBar=new Chart(document.getElementById("monthlyPerformanceBarChart").getContext("2d"),{type:"bar",data:{labels:App.constants.monthNames.slice(0,12),datasets:[{label:"Ganhos Totais",data:e.gains,backgroundColor:"#32d74b"},{label:"Gastos Totais",data:e.expenses,backgroundColor:"#ff453a"}]},options:n})},renderCardList:()=>{App.ui.cardListContainer.innerHTML=App.state.creditCards.map(e=>`<div class="flex items-center justify-between p-2 rounded-lg" style="background-color: var(--input-bg);"><span class="text-color">${e}</span><button class="remove-card-btn text-red-500 hover:text-red-700" data-card-name="${e}">×</button></div>`).join("")},renderCategoryList:()=>{App.ui.categoryListContainer.innerHTML=App.state.categories.map(e=>`<div class="flex items-center justify-between p-2 rounded-lg gap-2" style="background-color: var(--input-bg);"><input type="text" value="${e.name}" class="category-name-input flex-grow p-1 input-field" data-old-name="${e.name}"><input type="number" value="${e.budget}" min="0" class="category-budget-input w-24 p-1 input-field" data-category-name="${e.name}"><button class="remove-category-btn text-red-500 hover:text-red-700" data-category-name="${e.name}">×</button></div>`).join("")},renderRecurringList:()=>{App.ui.recurringListContainer.innerHTML=App.state.recurringEntries.map((e,t)=>`<div class="text-xs p-2 rounded-lg flex justify-between items-center" style="background-color: var(--input-bg);"><div><p class="font-bold text-color">${e.description} (${App.helpers.formatCurrency(e.amount)})</p><p class="muted-text">Todo dia ${e.dayOfMonth} - ${e.type}</p></div><button class="remove-recurring-btn text-red-500 hover:text-red-700 font-bold" data-index="${t}">×</button></div>`).join("")},renderSettingsModal:()=>{App.render.renderCardList(),App.render.renderCategoryList(),App.render.renderRecurringList(),document.getElementById("recurring-category").innerHTML=App.state.categories.map(e=>`<option value="${e.name}">${e.name}</option>`).join(""),document.getElementById("recurring-payment").innerHTML=App.constants.basePaymentMethods.map(e=>`<option value="${e}">${e}</option>`).join(""),document.getElementById("recurring-card").innerHTML=App.state.creditCards.map(e=>`<option value="${e}">${e}</option>`).join(""),App.ui.settingsModal.classList.remove("hidden"),setTimeout(()=>App.ui.settingsModal.querySelector(".modal-content").classList.remove("scale-95"),10)},renderAccountModal:()=>{const e=auth.currentUser;if(e){App.ui.userNameInput.value=App.state.profile.name||"",App.ui.userEmailDisplay.value=e.email||"";const t=App.state.integrations.whatsapp;App.ui.whatsappPhoneId.value=t.phoneNumberId||"",App.ui.whatsappToken.value=t.accessToken||"",App.ui.whatsappWebhookUrl.value=`${window.location.origin}/api/whatsapp-webhook`,App.ui.whatsappVerifyToken.value=t.webhookVerifyToken||"",t.phoneNumberId&&t.accessToken?(App.ui.whatsappStatus.textContent="Configurado",App.ui.whatsappStatus.style.color="var(--green-color)"):(App.ui.whatsappStatus.textContent="Não configurado",App.ui.whatsappStatus.style.color="var(--muted-text)"),App.ui.accountModal.classList.remove("hidden"),setTimeout(()=>App.ui.accountModal.querySelector(".modal-content").classList.remove("scale-95"),10)}}}};window.App=App,onAuthStateChanged(auth,e=>{e?(authScreen.classList.add("hidden"),appScreen.classList.remove("hidden"),loadingOverlay.classList.remove("hidden"),App.init(e.uid)):(App.state.currentUserId=null,setAuthMode("login"),authScreen.classList.remove("hidden"),appScreen.classList.add("hidden"))})</script></body></html>